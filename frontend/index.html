<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票K线可视化</title>
    <!-- 引入ECharts -->
    <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 引入Axios -->
    <script src="https://unpkg.com/axios@1.6.2/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .input-section {
            margin-bottom: 20px;
            text-align: center;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        .input-section input {
            padding: 8px 12px;
            font-size: 16px;
            width: 300px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .input-section button {
            padding: 8px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .input-section button:hover {
            background-color: #45a049;
        }
        .input-section button.search-btn {
            background-color: #2196F3;
        }
        .input-section button.search-btn:hover {
            background-color: #0b7dda;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: none;
        }
        .search-results.show {
            display: block;
        }
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-code {
            font-weight: bold;
            color: #2196F3;
        }
        .search-result-name {
            color: #666;
            margin-left: 10px;
        }
        #chart-container {
            width: 100%;
            height: 1100px;
        }
        .error-message {
            color: red;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section" style="position: relative;">
                <input type="text" id="stock-symbol" placeholder="输入股票代码或名称，例如：000001 或 浦发银行" value="000001" oninput="handleSearchInput(this.value)">
                <button onclick="fetchStockData()">获取数据</button>
                <div class="search-results" id="search-results"></div>
            </div>
        
        <div id="chart-container"></div>
        
        <div class="error-message" id="error-message"></div>
    </div>

    <!-- 技术指标参考指南 -->
    <div class="container" style="margin-top: 20px;">
        <h2 style="text-align: center; color: #333;">技术指标参考指南</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">VOL（成交量）</h3>
                <p><strong>含义：</strong>成交量是指股票在一定时间内的成交数量，反映市场的活跃度和资金流向。</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>价升量增：上涨趋势可能持续</li>
                    <li>价升量减：上涨动力不足，可能回调</li>
                    <li>价跌量增：下跌趋势可能持续</li>
                    <li>价跌量减：下跌动力不足，可能反弹</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">MACD（指数平滑异同移动平均线）</h3>
                <p><strong>构成：</strong>DIF（快线）、DEA（慢线）、MACD柱状图</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>金叉：DIF上穿DEA，买入信号</li>
                    <li>死叉：DIF下穿DEA，卖出信号</li>
                    <li>顶背离：价格创新高，MACD未创新高，可能见顶</li>
                    <li>底背离：价格创新低，MACD未创新低，可能见底</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">RSI（相对强弱指标）</h3>
                <p><strong>取值范围：</strong>0-100</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>RSI > 70：超买区域，可能回调</li>
                    <li>RSI < 30：超卖区域，可能反弹</li>
                    <li>RSI在50左右：市场处于平衡状态</li>
                    <li>RSI趋势与价格趋势背离：可能反转</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">KDJ（随机指标）</h3>
                <p><strong>构成：</strong>K线（快速线）、D线（慢速线）、J线（确认线）</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>金叉：K线上穿D线，买入信号</li>
                    <li>死叉：K线下穿D线，卖出信号</li>
                    <li>J线>100：超买，可能回调</li>
                    <li>J线<0：超卖，可能反弹</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">BOLL（布林带）</h3>
                <p><strong>构成：</strong>上轨、中轨（移动平均线）、下轨</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>价格突破上轨：可能继续上涨，或回调</li>
                    <li>价格突破下轨：可能继续下跌，或反弹</li>
                    <li>布林带收窄：市场即将变盘</li>
                    <li>布林带扩张：市场波动加大</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let isRequesting = false; // 请求状态标志
        let searchTimeout = null; // 搜索防抖
        
        // 搜索股票
        function searchStocks() {
            const keyword = document.getElementById('stock-symbol').value.trim();
            const searchResults = document.getElementById('search-results');
            
            if (!keyword) {
                searchResults.classList.remove('show');
                return;
            }
            
            axios.get(`http://localhost:5001/api/stock/search?keyword=${encodeURIComponent(keyword)}&limit=10`)
                .then(response => {
                    if (response.data.success && response.data.data.length > 0) {
                        const results = response.data.data;
                        let html = '';
                        results.forEach(item => {
                            html += `
                                <div class="search-result-item" onclick="selectStock('${item.code}', '${item.name}')">
                                    <span class="search-result-code">${item.code}</span>
                                    <span class="search-result-name">${item.name}</span>
                                </div>
                            `;
                        });
                        searchResults.innerHTML = html;
                        searchResults.classList.add('show');
                    } else {
                        searchResults.innerHTML = '<div class="search-result-item" style="color: #999;">未找到匹配的股票</div>';
                        searchResults.classList.add('show');
                    }
                })
                .catch(error => {
                    console.error('搜索失败:', error);
                    searchResults.innerHTML = '<div class="search-result-item" style="color: red;">搜索失败，请重试</div>';
                    searchResults.classList.add('show');
                });
        }
        
        // 处理搜索输入（防抖）
        function handleSearchInput(value) {
            const searchResults = document.getElementById('search-results');
            
            clearTimeout(searchTimeout);
            
            if (value.length < 2) {
                searchResults.classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                searchStocks();
            }, 300);
        }
        
        // 选择股票
        function selectStock(code, name) {
            document.getElementById('stock-symbol').value = `${code} - ${name}`;
            document.getElementById('search-results').classList.remove('show');
            fetchStockData();
        }
        
        // 点击页面其他地方关闭搜索结果
        document.addEventListener('click', function(event) {
            const searchResults = document.getElementById('search-results');
            const inputSection = document.querySelector('.input-section');
            
            if (!inputSection.contains(event.target)) {
                searchResults.classList.remove('show');
            }
        });
        
        // 页面加载完成后初始化
        window.onload = function() {
            try {
                // 检查echarts是否加载
                if (typeof echarts === 'undefined') {
                    document.getElementById('error-message').textContent = 'ECharts库加载失败，请刷新页面重试';
                    return;
                }
                
                // 初始化图表
                chart = echarts.init(document.getElementById('chart-container'));
                
                // 配置项
                const option = {
                    title: {
                        text: '股票K线图',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: ['K线'],
                        bottom: 10
                    },
                    dataZoom: [
                        {
                            type: 'inside',
                            start: 0,
                            end: 100
                        },
                        {
                            show: true,
                            type: 'slider',
                            bottom: '0%',
                            start: 0,
                            end: 100
                        }
                    ],
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: [],
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: {
                        type: 'value',
                        scale: true
                    },
                    series: [
                        {
                            name: 'K线',
                            type: 'candlestick',
                            data: [],
                            itemStyle: {
                                color: '#ef5350',
                                color0: '#26a69a',
                                borderColor: '#ef5350',
                                borderColor0: '#26a69a'
                            },
                            // 调整蜡烛图样式，确保影线清晰可见
                            emphasis: {
                                itemStyle: {
                                    color: '#ff5722',
                                    color0: '#4caf50',
                                    borderColor: '#ff5722',
                                    borderColor0: '#4caf50'
                                }
                            }
                        }
                    ]
                };
                
                chart.setOption(option);
                
                // 延迟1秒获取数据，确保后端服务完全启动
                setTimeout(function() {
                    fetchStockData();
                }, 1000);
                
                // 响应式调整
                window.addEventListener('resize', function() {
                    if (chart) {
                        chart.resize();
                    }
                });
            } catch (error) {
                document.getElementById('error-message').textContent = `初始化错误: ${error.message}`;
                console.error('初始化错误:', error);
            }
        };
        
        // 计算移动平均线
        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push('-');
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j][1]; // close price
                }
                result.push((sum / period).toFixed(2));
            }
            return result;
        }
        
        // 将英文时间格式转换为中文格式
        function formatDateToChinese(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[date.getDay()];
            return `${year}年${month}月${day}日 ${weekday}`;
        }
        
        // 计算成交量移动平均线
        function calculateVolumeMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push('-');
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j];
                }
                result.push((sum / period).toFixed(2));
            }
            return result;
        }
        
        // 计算RSI指标
        function calculateRSI(data, period = 14) {
            const result = [];
            let gains = [];
            let losses = [];
            
            // 计算每日涨跌幅度
            for (let i = 1; i < data.length; i++) {
                const change = data[i][1] - data[i-1][1];
                if (change > 0) {
                    gains.push(change);
                    losses.push(0);
                } else {
                    gains.push(0);
                    losses.push(Math.abs(change));
                }
            }
            
            // 计算RSI
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    result.push('-');
                    continue;
                }
                
                // 计算平均 gain 和平均 loss
                let avgGain = 0;
                let avgLoss = 0;
                for (let j = 0; j < period; j++) {
                    avgGain += gains[i-1-j];
                    avgLoss += losses[i-1-j];
                }
                avgGain /= period;
                avgLoss /= period;
                
                // 计算RSI
                let rsi;
                if (avgLoss === 0) {
                    rsi = 100;
                } else {
                    const rs = avgGain / avgLoss;
                    rsi = 100 - (100 / (1 + rs));
                }
                
                result.push(rsi.toFixed(2));
            }
            
            return result;
        }
        
        // 计算KDJ指标
        function calculateKDJ(data, period = 9, kPeriod = 3, dPeriod = 3) {
            const lowList = [];
            const highList = [];
            const rsvList = [];
            const kList = [];
            const dList = [];
            const jList = [];
            
            // 计算每个周期的最高价和最低价
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    lowList.push(data[i][2]); // low
                    highList.push(data[i][3]); // high
                    rsvList.push('-');
                    kList.push('-');
                    dList.push('-');
                    jList.push('-');
                } else {
                    // 计算period周期内的最高价和最低价
                    let periodLow = Infinity;
                    let periodHigh = -Infinity;
                    for (let j = 0; j < period; j++) {
                        periodLow = Math.min(periodLow, data[i-j][2]);
                        periodHigh = Math.max(periodHigh, data[i-j][3]);
                    }
                    lowList.push(periodLow);
                    highList.push(periodHigh);
                    
                    // 计算RSV
                    const close = data[i][1];
                    let rsv;
                    if (periodHigh === periodLow) {
                        rsv = 50;
                    } else {
                        rsv = ((close - periodLow) / (periodHigh - periodLow)) * 100;
                    }
                    rsvList.push(rsv.toFixed(2));
                    
                    // 计算K、D、J
                    let k, d, j;
                    if (i === period - 1) {
                        // 第一个计算点
                        k = rsv;
                        d = rsv;
                    } else {
                        k = (2/3) * parseFloat(kList[i-1]) + (1/3) * rsv;
                        d = (2/3) * parseFloat(dList[i-1]) + (1/3) * k;
                    }
                    j = 3 * k - 2 * d;
                    
                    kList.push(k.toFixed(2));
                    dList.push(d.toFixed(2));
                    jList.push(j.toFixed(2));
                }
            }
            
            return { k: kList, d: dList, j: jList };
        }
        
        // 计算BOLL指标
        function calculateBOLL(data, period = 20, multiplier = 2) {
            const maList = [];
            const upperList = [];
            const lowerList = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    maList.push('-');
                    upperList.push('-');
                    lowerList.push('-');
                } else {
                    // 计算MA
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i-j][1]; // close
                    }
                    const ma = sum / period;
                    maList.push(ma.toFixed(2));
                    
                    // 计算标准差
                    let variance = 0;
                    for (let j = 0; j < period; j++) {
                        variance += Math.pow(data[i-j][1] - ma, 2);
                    }
                    const stdDev = Math.sqrt(variance / period);
                    
                    // 计算上轨和下轨
                    const upper = ma + multiplier * stdDev;
                    const lower = ma - multiplier * stdDev;
                    upperList.push(upper.toFixed(2));
                    lowerList.push(lower.toFixed(2));
                }
            }
            
            return { ma: maList, upper: upperList, lower: lowerList };
        }
        
        // 计算MACD
        function calculateMACD(data, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const ema12 = [];
            const ema26 = [];
            const dif = [];
            const dea = [];
            const macd = [];
            
            // 计算EMA12和EMA26
            for (let i = 0; i < data.length; i++) {
                const close = data[i][1];
                
                if (i === 0) {
                    ema12.push(close);
                    ema26.push(close);
                } else {
                    const k12 = 2 / (fastPeriod + 1);
                    const k26 = 2 / (slowPeriod + 1);
                    ema12.push((close - ema12[i - 1]) * k12 + ema12[i - 1]);
                    ema26.push((close - ema26[i - 1]) * k26 + ema26[i - 1]);
                }
                
                dif.push(ema12[i] - ema26[i]);
            }
            
            // 计算DEA和MACD
            for (let i = 0; i < dif.length; i++) {
                if (i === 0) {
                    dea.push(dif[i]);
                } else {
                    const k = 2 / (signalPeriod + 1);
                    dea.push((dif[i] - dea[i - 1]) * k + dea[i - 1]);
                }
                macd.push((dif[i] - dea[i]) * 2);
            }
            
            return { dif, dea, macd };
        }
        
        // 基于单一指标的价值判断逻辑
        function analyzeSingleIndicator(data, volumeData, macdResult, rsiData, kdjResult, bollResult) {
            const result = {
                vol: '持有',
                macd: '持有',
                rsi: '持有',
                kdj: '持有',
                boll: '持有'
            };
            
            // 分析VOL
            if (volumeData.length >= 2) {
                const currentVol = volumeData[volumeData.length - 1];
                const prevVol = volumeData[volumeData.length - 2];
                const currentPrice = data[data.length - 1][1];
                const prevPrice = data[data.length - 2][1];
                
                if (currentVol > prevVol * 1.5 && currentPrice > prevPrice) {
                    result.vol = '买入';
                } else if (currentVol > prevVol * 1.5 && currentPrice < prevPrice) {
                    result.vol = '卖出';
                }
            }
            
            // 分析MACD
            if (macdResult.dif.length >= 2 && macdResult.dea.length >= 2) {
                const currentDif = macdResult.dif[macdResult.dif.length - 1];
                const prevDif = macdResult.dif[macdResult.dif.length - 2];
                const currentDea = macdResult.dea[macdResult.dea.length - 1];
                const prevDea = macdResult.dea[macdResult.dea.length - 2];
                
                if (currentDif > currentDea && prevDif <= prevDea) {
                    result.macd = '买入';
                } else if (currentDif < currentDea && prevDif >= prevDea) {
                    result.macd = '卖出';
                }
            }
            
            // 分析RSI
            if (rsiData.length >= 1) {
                const currentRsi = parseFloat(rsiData[rsiData.length - 1]);
                if (!isNaN(currentRsi)) {
                    if (currentRsi < 30) {
                        result.rsi = '买入';
                    } else if (currentRsi > 70) {
                        result.rsi = '卖出';
                    }
                }
            }
            
            // 分析KDJ
            if (kdjResult.k.length >= 2 && kdjResult.d.length >= 2) {
                const currentK = parseFloat(kdjResult.k[kdjResult.k.length - 1]);
                const prevK = parseFloat(kdjResult.k[kdjResult.k.length - 2]);
                const currentD = parseFloat(kdjResult.d[kdjResult.d.length - 1]);
                const prevD = parseFloat(kdjResult.d[kdjResult.d.length - 2]);
                
                if (!isNaN(currentK) && !isNaN(currentD) && !isNaN(prevK) && !isNaN(prevD)) {
                    if (currentK > currentD && prevK <= prevD) {
                        result.kdj = '买入';
                    } else if (currentK < currentD && prevK >= prevD) {
                        result.kdj = '卖出';
                    }
                }
            }
            
            // 分析BOLL
            if (bollResult.upper.length >= 1 && bollResult.lower.length >= 1) {
                const currentPrice = data[data.length - 1][1];
                const currentUpper = parseFloat(bollResult.upper[bollResult.upper.length - 1]);
                const currentLower = parseFloat(bollResult.lower[bollResult.lower.length - 1]);
                
                if (!isNaN(currentUpper) && !isNaN(currentLower)) {
                    if (currentPrice <= currentLower) {
                        result.boll = '买入';
                    } else if (currentPrice >= currentUpper) {
                        result.boll = '卖出';
                    }
                }
            }
            
            return result;
        }
        
        // 综合多指标的价值判断逻辑
        function analyzeCompositeIndicator(singleResult) {
            let buyCount = 0;
            let sellCount = 0;
            
            // 统计买入和卖出信号数量
            Object.values(singleResult).forEach(signal => {
                if (signal === '买入') {
                    buyCount++;
                } else if (signal === '卖出') {
                    sellCount++;
                }
            });
            
            // 基于信号数量生成综合判断
            if (buyCount >= 3) {
                return '买入';
            } else if (sellCount >= 3) {
                return '卖出';
            } else if (buyCount === 2 && sellCount === 0) {
                return '买入';
            } else if (sellCount === 2 && buyCount === 0) {
                return '卖出';
            } else {
                return '持有';
            }
        }
        
        // 存储当前数据
        let currentStockData = null;
        let currentKlineData = null;
        let currentVolumeData = null;
        let currentDates = null;
        let currentChineseDates = null;
        let currentMAData = null;
        let currentVolumeMAData = null;
        let currentMACDData = null;
        let currentRSIData = null;
        let currentKDJData = null;
        let currentBOLLData = null;
        
        // 获取股票数据
        function fetchStockData() {
            if (!chart) {
                document.getElementById('error-message').textContent = '图表未初始化，请刷新页面重试';
                return;
            }
            
            // 检查是否正在请求中
            if (isRequesting) {
                document.getElementById('error-message').textContent = '提示: 正在获取数据，请稍后再试';
                return;
            }
            
            let symbol = document.getElementById('stock-symbol').value.trim();
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = '';
            
            // 处理 "code - name" 格式，只提取 code
            if (symbol.includes(' - ')) {
                symbol = symbol.split(' - ')[0].trim();
            }
            
            try {
                // 设置请求状态为正在请求
                isRequesting = true;
                
                // 显示加载状态
                chart.setOption({
                    title: {
                        text: `股票K线图 - ${symbol} (加载中...)`
                    }
                });
                
                // 调用后端API，增加超时设置
                axios.get(`http://localhost:5001/api/stock/kline/${symbol}`, {
                    timeout: 30000 // 30秒超时
                })
                    .then(response => {
                        // 设置请求状态为完成
                        isRequesting = false;
                        
                        if (response.data.success) {
                            const data = response.data.data;
                            currentStockData = data;
                            
                            // 处理数据
                            const dates = [];
                            const klineData = [];
                            const chineseDates = [];
                            const volumeData = [];
                            
                            data.forEach(item => {
                                dates.push(item.date);
                                chineseDates.push(formatDateToChinese(item.date));
                                // 确保数据类型为数字，并按ECharts要求的顺序：[open, close, low, high]
                                klineData.push([
                                    parseFloat(item.open),
                                    parseFloat(item.close),
                                    parseFloat(item.low),
                                    parseFloat(item.high)
                                ]);
                                // 提取成交量数据
                                volumeData.push(parseFloat(item.volume));
                            });
                            
                            currentDates = dates;
                            currentKlineData = klineData;
                            currentChineseDates = chineseDates;
                            currentVolumeData = volumeData;
                            
                            // 计算MA
                            const ma5 = calculateMA(klineData, 5);
                            const ma10 = calculateMA(klineData, 10);
                            const ma20 = calculateMA(klineData, 20);
                            const ma30 = calculateMA(klineData, 30);
                            const ma60 = calculateMA(klineData, 60);
                            
                            currentMAData = {
                                ma5: ma5,
                                ma10: ma10,
                                ma20: ma20,
                                ma30: ma30,
                                ma60: ma60
                            };
                            
                            // 计算成交量均线
                            const volMA5 = calculateVolumeMA(volumeData, 5);
                            const volMA10 = calculateVolumeMA(volumeData, 10);
                            
                            currentVolumeMAData = {
                                volMA5: volMA5,
                                volMA10: volMA10
                            };
                            
                            // 计算MACD
                            const macdResult = calculateMACD(klineData);
                            currentMACDData = macdResult;
                            
                            // 计算RSI
                            const rsi14 = calculateRSI(klineData, 14);
                            currentRSIData = rsi14;
                            
                            // 计算KDJ
                            const kdjResult = calculateKDJ(klineData);
                            currentKDJData = kdjResult;
                            
                            // 计算BOLL
                            const bollResult = calculateBOLL(klineData);
                            currentBOLLData = bollResult;
                            
                            // 分析股票价值
                            const singleResult = analyzeSingleIndicator(klineData, volumeData, macdResult, rsi14, kdjResult, bollResult);
                            const compositeResult = analyzeCompositeIndicator(singleResult);
                            
                            // 更新图表
                            chart.setOption({
                                title: [
                                    {
                                        text: `股票K线图 - ${symbol}`,
                                        left: 'center',
                                        top: '5%',
                                        subtext: `综合判断: ${compositeResult} | 买入信号: ${Object.values(singleResult).filter(s => s === '买入').length} | 卖出信号: ${Object.values(singleResult).filter(s => s === '卖出').length}`,
                                        subtextStyle: {
                                            fontSize: 12,
                                            color: compositeResult === '买入' ? '#4CAF50' : compositeResult === '卖出' ? '#f44336' : '#ff9800'
                                        }
                                    },
                                    {
                                        text: 'VOL图',
                                        left: 'center',
                                        top: '38%',
                                        subtext: `成交量：反映市场活跃度，量价配合是重要参考 | VOL判断: ${singleResult.vol}`,
                                        subtextStyle: {
                                            fontSize: 10,
                                            color: singleResult.vol === '买入' ? '#4CAF50' : singleResult.vol === '卖出' ? '#f44336' : '#666'
                                        }
                                    },
                                    {
                                        text: 'MACD图',
                                        left: 'center',
                                        top: '51%',
                                        subtext: `MACD：由DIF、DEA和柱状图组成，反映趋势和动量 | MACD判断: ${singleResult.macd}`,
                                        subtextStyle: {
                                            fontSize: 10,
                                            color: singleResult.macd === '买入' ? '#4CAF50' : singleResult.macd === '卖出' ? '#f44336' : '#666'
                                        }
                                    },
                                    {
                                        text: 'RSI图',
                                        left: 'center',
                                        top: '64%',
                                        subtext: `RSI：0-100取值，>70超买，<30超卖 | RSI判断: ${singleResult.rsi}`,
                                        subtextStyle: {
                                            fontSize: 10,
                                            color: singleResult.rsi === '买入' ? '#4CAF50' : singleResult.rsi === '卖出' ? '#f44336' : '#666'
                                        }
                                    },
                                    {
                                        text: 'KDJ图',
                                        left: 'center',
                                        top: '77%',
                                        subtext: `KDJ：K、D、J三线，反映价格强弱和超买超卖 | KDJ判断: ${singleResult.kdj}`,
                                        subtextStyle: {
                                            fontSize: 10,
                                            color: singleResult.kdj === '买入' ? '#4CAF50' : singleResult.kdj === '卖出' ? '#f44336' : '#666'
                                        }
                                    },
                                    {
                                        text: 'BOLL图',
                                        left: 'center',
                                        top: '90%',
                                        subtext: `BOLL：由上中下轨组成，反映价格波动区间 | BOLL判断: ${singleResult.boll}`,
                                        subtextStyle: {
                                            fontSize: 10,
                                            color: singleResult.boll === '买入' ? '#4CAF50' : singleResult.boll === '卖出' ? '#f44336' : '#666'
                                        }
                                    }
                                ],
                                
                                
                                
                                
                                
                                tooltip: {
                                    trigger: 'axis',
                                    axisPointer: {
                                        type: 'cross'
                                    },
                                    formatter: function(params) {
                                        const index = params[0].dataIndex;
                                        let result = chineseDates[index] + '<br/>';
                                        
                                        // 处理K线数据
                                        if (params[0].seriesName === 'K线') {
                                            const data = params[0].data;
                                            result += `开盘: ${data[0]}<br/>`;
                                            result += `收盘: ${data[1]}<br/>`;
                                            result += `最低: ${data[2]}<br/>`;
                                            result += `最高: ${data[3]}<br/>`;
                                        }
                                        
                                        // 处理MA数据
                                        params.forEach(param => {
                                            if (param.seriesName.includes('MA')) {
                                                result += `${param.seriesName}: ${param.value}<br/>`;
                                            }
                                        });
                                        
                                        // 处理成交量数据
                                        params.forEach(param => {
                                            if (param.seriesName === '成交量' || param.seriesName.includes('VOL')) {
                                                result += `${param.seriesName}: ${param.value}<br/>`;
                                            }
                                        });
                                        
                                        // 处理MACD数据
                                        const hasMACD = params.some(param => param.seriesName === 'DIF' || param.seriesName === 'DEA' || param.seriesName === 'MACD');
                                        if (hasMACD) {
                                            result += '<br/><b>MACD指标说明:</b><br/>';
                                            result += 'DIF: 快速与慢速移动平均线的差<br/>';
                                            result += 'DEA: DIF的移动平均线<br/>';
                                            result += 'MACD: (DIF-DEA)×2，反映动量变化<br/>';
                                            result += '金叉: DIF上穿DEA，可能的买入信号<br/>';
                                            result += '死叉: DIF下穿DEA，可能的卖出信号<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'DIF' || param.seriesName === 'DEA' || param.seriesName === 'MACD') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理RSI数据
                                        const hasRSI = params.some(param => param.seriesName === 'RSI14');
                                        if (hasRSI) {
                                            result += '<br/><b>RSI指标说明:</b><br/>';
                                            result += '相对强弱指标，取值范围0-100<br/>';
                                            result += 'RSI > 70: 超买区域，可能回调<br/>';
                                            result += 'RSI < 30: 超卖区域，可能反弹<br/>';
                                            result += 'RSI在50左右: 市场处于平衡状态<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'RSI14') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理KDJ数据
                                        const hasKDJ = params.some(param => param.seriesName === 'K' || param.seriesName === 'D' || param.seriesName === 'J');
                                        if (hasKDJ) {
                                            result += '<br/><b>KDJ指标说明:</b><br/>';
                                            result += 'K线: 快速随机指标<br/>';
                                            result += 'D线: 慢速随机指标<br/>';
                                            result += 'J线: K和D的乖离率<br/>';
                                            result += '金叉: K上穿D，可能的买入信号<br/>';
                                            result += '死叉: K下穿D，可能的卖出信号<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'K' || param.seriesName === 'D' || param.seriesName === 'J') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理BOLL数据
                                        const hasBOLL = params.some(param => param.seriesName.includes('BOLL'));
                                        if (hasBOLL) {
                                            result += '<br/><b>BOLL指标说明:</b><br/>';
                                            result += '上轨: 价格波动的压力线<br/>';
                                            result += '中轨: 价格的移动平均线<br/>';
                                            result += '下轨: 价格波动的支撑线<br/>';
                                            result += '价格突破上轨: 可能继续上涨<br/>';
                                            result += '价格突破下轨: 可能继续下跌<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName.includes('BOLL')) {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        return result;
                                    }
                                },
                                legend: {
                                    data: ['K线', 'MA5', 'MA10', 'MA20', 'MA30', 'MA60', '成交量', 'VOL5', 'VOL10', 'DIF', 'DEA', 'MACD', 'RSI14', 'K', 'D', 'J', 'BOLL上轨', 'BOLL中轨', 'BOLL下轨'],
                                    top: 40,
                                    type: 'scroll',
                                    textStyle: {
                                        fontSize: 10
                                    }
                                },
                                dataZoom: [
                                    {
                                        type: 'inside',
                                        start: 0,
                                        end: 100,
                                        xAxisIndex: [0, 1, 2, 3, 4, 5]
                                    },
                                    {
                                        show: true,
                                        type: 'slider',
                                        bottom: '0%',
                                        start: 0,
                                        end: 100,
                                        xAxisIndex: [0, 1, 2, 3, 4, 5]
                                    }
                                ],
                                
                                grid: [
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '10%',
                                        height: '25%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '40%',
                                        height: '8%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '53%',
                                        height: '8%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '66%',
                                        height: '8%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '79%',
                                        height: '8%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '92%',
                                        height: '8%',
                                        containLabel: true
                                    }
                                ],
                                xAxis: [
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        axisLabel: {
                                            rotate: 45,
                                            interval: 20 // 减少显示的标签数量，避免拥挤
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 1,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 2,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 3,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 4,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 5,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    }
                                ],
                                yAxis: [
                                    {
                                        type: 'value',
                                        scale: true,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 1,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 2,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 3,
                                        min: 0,
                                        max: 100,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 4,
                                        min: 0,
                                        max: 100,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 5,
                                        splitArea: {
                                            show: true
                                        }
                                    }
                                ],
                                
                                series: [
                                    {
                                        name: 'K线',
                                        type: 'candlestick',
                                        data: klineData,
                                        itemStyle: {
                                            color: '#ef5350',
                                            color0: '#26a69a',
                                            borderColor: '#ef5350',
                                            borderColor0: '#26a69a'
                                        }
                                    },
                                    // 价值判断信号标记
                                    {
                                        name: '买入信号',
                                        type: 'scatter',
                                        data: (function() {
                                            const signals = [];
                                            // 这里可以根据需要添加买入信号点
                                            // 暂时只在最后一个数据点添加信号（如果是买入）
                                            if (compositeResult === '买入') {
                                                const lastData = klineData[klineData.length - 1];
                                                signals.push([
                                                    klineData.length - 1,
                                                    lastData[3] * 1.02, // 在最高价上方显示
                                                    '买入'
                                                ]);
                                            }
                                            return signals;
                                        })(),
                                        symbolSize: 15,
                                        itemStyle: {
                                            color: '#4CAF50'
                                        },
                                        label: {
                                            show: true,
                                            position: 'top',
                                            formatter: '{c}'
                                        }
                                    },
                                    {
                                        name: '卖出信号',
                                        type: 'scatter',
                                        data: (function() {
                                            const signals = [];
                                            // 这里可以根据需要添加卖出信号点
                                            // 暂时只在最后一个数据点添加信号（如果是卖出）
                                            if (compositeResult === '卖出') {
                                                const lastData = klineData[klineData.length - 1];
                                                signals.push([
                                                    klineData.length - 1,
                                                    lastData[2] * 0.98, // 在最低价下方显示
                                                    '卖出'
                                                ]);
                                            }
                                            return signals;
                                        })(),
                                        symbolSize: 15,
                                        itemStyle: {
                                            color: '#f44336'
                                        },
                                        label: {
                                            show: true,
                                            position: 'bottom',
                                            formatter: '{c}'
                                        }
                                    },
                                    {
                                        name: 'MA5',
                                        type: 'line',
                                        data: ma5,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'MA10',
                                        type: 'line',
                                        data: ma10,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'MA20',
                                        type: 'line',
                                        data: ma20,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#9C27B0'
                                        }
                                    },
                                    {
                                        name: 'MA30',
                                        type: 'line',
                                        data: ma30,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#795548'
                                        }
                                    },
                                    {
                                        name: 'MA60',
                                        type: 'line',
                                        data: ma60,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#607D8B'
                                        }
                                    },
                                    {
                                        name: '成交量',
                                        type: 'bar',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: volumeData,
                                        itemStyle: {
                                            color: function(params) {
                                                // 根据收盘价与开盘价的比较设置成交量颜色
                                                const klineItem = klineData[params.dataIndex];
                                                return klineItem[1] >= klineItem[0] ? '#ef5350' : '#26a69a';
                                            }
                                        }
                                    },
                                    {
                                        name: 'VOL5',
                                        type: 'line',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: volMA5,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'VOL10',
                                        type: 'line',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: volMA10,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'DIF',
                                        type: 'line',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.dif.map(val => val.toFixed(4)),
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'DEA',
                                        type: 'line',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.dea.map(val => val.toFixed(4)),
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'MACD',
                                        type: 'bar',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.macd.map(val => val.toFixed(4)),
                                        itemStyle: {
                                            color: function(params) {
                                                return params.value >= 0 ? '#ef5350' : '#26a69a';
                                            }
                                        }
                                    },
                                    {
                                        name: 'RSI14',
                                        type: 'line',
                                        xAxisIndex: 3,
                                        yAxisIndex: 3,
                                        data: rsi14,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF5722'
                                        }
                                    },
                                    {
                                        name: 'K',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.k,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'D',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.d,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'J',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.j,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#4CAF50'
                                        }
                                    },
                                    {
                                        name: 'BOLL上轨',
                                        type: 'line',
                                        xAxisIndex: 5,
                                        yAxisIndex: 5,
                                        data: bollResult.upper,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF5722'
                                        }
                                    },
                                    {
                                        name: 'BOLL中轨',
                                        type: 'line',
                                        xAxisIndex: 5,
                                        yAxisIndex: 5,
                                        data: bollResult.ma,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'BOLL下轨',
                                        type: 'line',
                                        xAxisIndex: 5,
                                        yAxisIndex: 5,
                                        data: bollResult.lower,
                                        smooth: true,
                                        lineStyle: {
                                            width: 1,
                                            color: '#4CAF50'
                                        }
                                    }
                                ]
                            });
                        } else {
                            errorMessage.textContent = `错误: ${response.data.error}`;
                        }
                    })
                    .catch(error => {
                        // 设置请求状态为完成
                        isRequesting = false;
                        
                        if (error.code === 'ECONNABORTED') {
                            errorMessage.textContent = '错误: 请求超时，请稍后再试';
                        } else if (error.message.includes('Network Error')) {
                            errorMessage.textContent = '错误: 网络连接失败，请检查后端服务是否运行';
                        } else if (error.message.includes('ERR_ABORTED')) {
                            errorMessage.textContent = '错误: 请求被中止，可能是网络连接问题，请稍后再试';
                        } else if (error.response) {
                            // 后端返回了错误响应
                            if (error.response.status === 500) {
                                errorMessage.textContent = '错误: 后端服务处理失败，可能是外部API连接问题';
                            } else {
                                errorMessage.textContent = `错误: ${error.response.status} - ${error.response.statusText}`;
                            }
                        } else {
                            errorMessage.textContent = `请求失败: ${error.message}`;
                        }
                    });
            } catch (error) {
                // 设置请求状态为完成
                isRequesting = false;
                
                errorMessage.textContent = `获取数据错误: ${error.message}`;
                console.error('获取数据错误:', error);
            }
        }
        
        // 导出数据
        function exportData() {
            if (!currentStockData) {
                document.getElementById('error-message').textContent = '提示: 暂无数据可导出，请先获取数据';
                return;
            }
            
            try {
                // 准备导出数据
                const exportData = {
                    symbol: document.getElementById('stock-symbol').value,
                    export_time: new Date().toISOString(),
                    original_data: currentStockData,
                    processed_data: {
                        kline_data: currentKlineData,
                        volume_data: currentVolumeData,
                        dates: currentDates,
                        chinese_dates: currentChineseDates
                    },
                    indicators: {
                        ma: currentMAData,
                        volume_ma: currentVolumeMAData,
                        macd: currentMACDData,
                        rsi: currentRSIData,
                        kdj: currentKDJData,
                        boll: currentBOLLData
                    },
                    metadata: {
                        data_points: currentStockData.length,
                        export_format: 'json'
                    }
                };
                
                // 转换为JSON字符串
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // 创建Blob对象
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_data_${exportData.symbol}_${new Date().toISOString().split('T')[0]}.json`;
                
                // 触发下载
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // 释放URL对象
                URL.revokeObjectURL(url);
                
                // 显示成功消息
                document.getElementById('error-message').textContent = '数据导出成功！';
                document.getElementById('error-message').style.color = 'green';
                
                // 3秒后清除消息
                setTimeout(() => {
                    document.getElementById('error-message').textContent = '';
                }, 3000);
                
                // 同时在新窗口中显示数据（可选）
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'text/plain' });
                const dataUrl = URL.createObjectURL(dataBlob);
                
                // 创建一个新窗口显示数据
                const newWindow = window.open('', '_blank', 'width=800,height=600');
                newWindow.document.write('<html><head><title>股票数据</title></head><body>');
                newWindow.document.write('<h1>股票数据详情</h1>');
                newWindow.document.write('<pre style="font-family: monospace; white-space: pre-wrap;">');
                newWindow.document.write(dataStr);
                newWindow.document.write('</pre>');
                newWindow.document.write('</body></html>');
                newWindow.document.close();
                
            } catch (error) {
                document.getElementById('error-message').textContent = `导出数据失败: ${error.message}`;
                console.error('导出数据失败:', error);
            }
        }
    </script>
</body>
</html>