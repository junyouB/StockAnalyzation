<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票K线可视化</title>
    <!-- 引入ECharts -->
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <!-- 引入Axios -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .input-section {
            margin-bottom: 20px;
            text-align: center;
        }
        .input-section input {
            padding: 8px 12px;
            font-size: 16px;
            width: 200px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .input-section button {
            padding: 8px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-section button:hover {
            background-color: #45a049;
        }
        #chart-container {
            width: 100%;
            height: 1100px;
        }
        .error-message {
            color: red;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section" style="position: relative;">
            <input type="text" id="stock-symbol" placeholder="输入股票代码或名称，例如：000001 或 浦发银行" value="000001" oninput="handleSearchInput(this.value)">
            <button onclick="fetchStockData()">获取数据</button>
            <button onclick="exportData()">导出数据</button>
            <button class="search-btn" onclick="searchStocks()">搜索</button>
            <div class="search-results" id="search-results"></div>
        </div>
        
        <div id="chart-container"></div>
        
        <div class="error-message" id="error-message"></div>
    </div>

    <!-- 技术指标参考指南 -->
    <div class="container" style="margin-top: 20px;">
        <h2 style="text-align: center; color: #333;">技术指标参考指南</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">VOL（成交量）</h3>
                <p><strong>含义：</strong>成交量是指股票在一定时间内的成交数量，反映市场的活跃度和资金流向。</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>价升量增：上涨趋势可能持续</li>
                    <li>价升量减：上涨动力不足，可能回调</li>
                    <li>价跌量增：下跌趋势可能持续</li>
                    <li>价跌量减：下跌动力不足，可能反弹</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">MACD（指数平滑异同移动平均线）</h3>
                <p><strong>构成：</strong>DIF（快线）、DEA（慢线）、MACD柱状图</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>金叉：DIF上穿DEA，买入信号</li>
                    <li>死叉：DIF下穿DEA，卖出信号</li>
                    <li>顶背离：价格创新高，MACD未创新高，可能见顶</li>
                    <li>底背离：价格创新低，MACD未创新低，可能见底</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">RSI（相对强弱指标）</h3>
                <p><strong>取值范围：</strong>0-100</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>RSI > 70：超买区域，可能回调</li>
                    <li>RSI < 30：超卖区域，可能反弹</li>
                    <li>RSI在50左右：市场处于平衡状态</li>
                    <li>RSI趋势与价格趋势背离：可能反转</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">KDJ（随机指标）</h3>
                <p><strong>构成：</strong>K线（快速线）、D线（慢速线）、J线（确认线）</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>金叉：K线上穿D线，买入信号</li>
                    <li>死叉：K线下穿D线，卖出信号</li>
                    <li>J线>100：超买，可能回调</li>
                    <li>J线<0：超卖，可能反弹</li>
                </ul>
            </div>
            
            <div style="padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
                <h3 style="color: #2196F3;">BOLL（布林带）</h3>
                <p><strong>构成：</strong>上轨、中轨（移动平均线）、下轨</p>
                <p><strong>解读：</strong></p>
                <ul>
                    <li>价格突破上轨：可能继续上涨，或回调</li>
                    <li>价格突破下轨：可能继续下跌，或反弹</li>
                    <li>布林带收窄：市场即将变盘</li>
                    <li>布林带扩张：市场波动加大</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let chart;
        let isRequesting = false; // 请求状态标志
        
        // 股票代码到公司名称的映射
        const stockNameMap = {
            '600036': '招商银行',
            '000001': '平安银行',
            '000002': '万科A',
            '600519': '贵州茅台',
            '601318': '中国平安',
            '600030': '中芯国际',
            '601888': '中国中车',
            '600000': '浦发银行',
            '601398': '工商银行',
            '601988': '中国银行',
            '600028': '中国石化',
            '601857': '中国石油'
        };
        
        // 公司名称到股票代码的映射（反向映射）
        const nameToStockCodeMap = {
            '招商银行': '600036',
            '平安银行': '000001',
            '万科A': '000002',
            '贵州茅台': '600519',
            '中国平安': '601318',
            '中芯国际': '600030',
            '中国中车': '601888',
            '浦发银行': '600000',
            '工商银行': '601398',
            '中国银行': '601988',
            '中国石化': '600028',
            '中国石油': '601857'
        };
        
        // 根据股票代码获取公司名称
        function getStockName(symbol) {
            return stockNameMap[symbol] || '';
        }
        
        // 根据公司名称获取股票代码
        function getStockCode(name) {
            return nameToStockCodeMap[name] || '';
        }
        
        // 当股票代码或公司名称输入时，显示对应信息
        function fetchStockName() {
            const input = document.getElementById('stock-symbol').value;
            const stockNameElement = document.getElementById('stock-name');
            
            // 判断输入的是股票代码还是公司名称
            const stockCode = getStockCode(input);
            const stockName = getStockName(input);
            
            if (stockCode && !stockName) {
                // 输入的是公司名称，显示股票代码
                stockNameElement.textContent = `股票代码：${stockCode}`;
            } else if (stockName && !stockCode) {
                // 输入的是股票代码，显示公司名称
                stockNameElement.textContent = `（${stockName}）`;
            } else {
                stockNameElement.textContent = '';
            }
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            try {
                // 检查echarts是否加载
                if (typeof echarts === 'undefined') {
                    document.getElementById('error-message').textContent = 'ECharts库加载失败，请刷新页面重试';
                    return;
                }
                
                // 初始化图表
                chart = echarts.init(document.getElementById('chart-container'));
                
                // 配置项
                const option = {
                    title: {
                        text: '股票K线图',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: ['K线'],
                        bottom: 10
                    },
                    dataZoom: [
                        {
                            type: 'inside',
                            start: 0,
                            end: 100
                        },
                        {
                            show: true,
                            type: 'slider',
                            bottom: '0%',
                            start: 0,
                            end: 100
                        }
                    ],
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: [],
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: {
                        type: 'value',
                        scale: true
                    },
                    series: [
                        {
                            name: 'K线',
                            type: 'candlestick',
                            data: [],
                            itemStyle: {
                                color: '#ef5350',
                                color0: '#26a69a',
                                borderColor: '#ef5350',
                                borderColor0: '#26a69a'
                            },
                            // 调整蜡烛图样式，确保影线清晰可见
                            emphasis: {
                                itemStyle: {
                                    color: '#ff5722',
                                    color0: '#4caf50',
                                    borderColor: '#ff5722',
                                    borderColor0: '#4caf50'
                                }
                            }
                        }
                    ]
                };
                
                chart.setOption(option);
                
                // 延迟1秒获取数据，确保后端服务完全启动
                setTimeout(function() {
                    fetchStockData();
                }, 1000);
                
                // 响应式调整
                window.addEventListener('resize', function() {
                    if (chart) {
                        chart.resize();
                    }
                });
            } catch (error) {
                document.getElementById('error-message').textContent = `初始化错误: ${error.message}`;
                console.error('初始化错误:', error);
            }
        };
        
        // 计算移动平均线
        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j][1]; // close price
                }
                result.push((sum / period).toFixed(2));
            }
            return result;
        }
        
        // 将英文时间格式转换为中文格式
        function formatDateToChinese(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[date.getDay()];
            return `${year}年${month}月${day}日 ${weekday}`;
        }
        
        // 计算成交量移动平均线
        function calculateVolumeMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j];
                }
                result.push((sum / period).toFixed(2));
            }
            return result;
        }
        
        // 计算RSI指标
        function calculateRSI(data, period = 14) {
            const result = [];
            let gains = [];
            let losses = [];
            
            // 计算每日涨跌幅度
            for (let i = 1; i < data.length; i++) {
                const change = data[i][1] - data[i-1][1];
                if (change > 0) {
                    gains.push(change);
                    losses.push(0);
                } else {
                    gains.push(0);
                    losses.push(Math.abs(change));
                }
            }
            
            // 计算RSI
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    result.push(null);
                    continue;
                }
                
                // 计算平均 gain 和平均 loss
                let avgGain = 0;
                let avgLoss = 0;
                for (let j = 0; j < period; j++) {
                    avgGain += gains[i-1-j];
                    avgLoss += losses[i-1-j];
                }
                avgGain /= period;
                avgLoss /= period;
                
                // 计算RSI
                let rsi;
                if (avgLoss === 0) {
                    rsi = 100;
                } else {
                    const rs = avgGain / avgLoss;
                    rsi = 100 - (100 / (1 + rs));
                }
                
                result.push(rsi.toFixed(2));
            }
            
            return result;
        }
        
        // 计算KDJ指标
        function calculateKDJ(data, period = 9, kPeriod = 3, dPeriod = 3) {
            const lowList = [];
            const highList = [];
            const rsvList = [];
            const kList = [];
            const dList = [];
            const jList = [];
            
            // 计算每个周期的最高价和最低价
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    lowList.push(data[i][2]); // low
                    highList.push(data[i][3]); // high
                    rsvList.push(null);
                    kList.push(null);
                    dList.push(null);
                    jList.push(null);
                } else {
                    // 计算period周期内的最高价和最低价
                    let periodLow = Infinity;
                    let periodHigh = -Infinity;
                    for (let j = 0; j < period; j++) {
                        periodLow = Math.min(periodLow, data[i-j][2]);
                        periodHigh = Math.max(periodHigh, data[i-j][3]);
                    }
                    lowList.push(periodLow);
                    highList.push(periodHigh);
                    
                    // 计算RSV
                    const close = data[i][1];
                    let rsv;
                    if (periodHigh === periodLow) {
                        rsv = 50;
                    } else {
                        rsv = ((close - periodLow) / (periodHigh - periodLow)) * 100;
                    }
                    rsvList.push(rsv.toFixed(2));
                    
                    // 计算K、D、J
                    let k, d, j;
                    if (i === period - 1) {
                        // 第一个计算点
                        k = rsv;
                        d = rsv;
                    } else {
                        k = (2/3) * parseFloat(kList[i-1]) + (1/3) * rsv;
                        d = (2/3) * parseFloat(dList[i-1]) + (1/3) * k;
                    }
                    j = 3 * k - 2 * d;
                    
                    kList.push(k.toFixed(2));
                    dList.push(d.toFixed(2));
                    jList.push(j.toFixed(2));
                }
            }
            
            return { k: kList, d: dList, j: jList };
        }
        
        // 计算BOLL指标
        function calculateBOLL(data, period = 20, multiplier = 2) {
            const maList = [];
            const upperList = [];
            const lowerList = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    maList.push(null);
                    upperList.push(null);
                    lowerList.push(null);
                } else {
                    // 计算MA
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i-j][1]; // close
                    }
                    const ma = sum / period;
                    maList.push(ma.toFixed(2));
                    
                    // 计算标准差
                    let variance = 0;
                    for (let j = 0; j < period; j++) {
                        variance += Math.pow(data[i-j][1] - ma, 2);
                    }
                    const stdDev = Math.sqrt(variance / period);
                    
                    // 计算上轨和下轨
                    const upper = ma + multiplier * stdDev;
                    const lower = ma - multiplier * stdDev;
                    upperList.push(upper.toFixed(2));
                    lowerList.push(lower.toFixed(2));
                }
            }
            
            return { ma: maList, upper: upperList, lower: lowerList };
        }
        
        // 分析MACD指标
        function analyzeMACD(macdResult) {
            const dif = macdResult.dif;
            const dea = macdResult.dea;
            
            if (dif.length < 2) return '观望';
            
            const lastDif = parseFloat(dif[dif.length - 1]);
            const lastDea = parseFloat(dea[dea.length - 1]);
            const prevDif = parseFloat(dif[dif.length - 2]);
            const prevDea = parseFloat(dea[dea.length - 2]);
            
            // 金叉：DIF上穿DEA
            if (prevDif <= prevDea && lastDif > lastDea) {
                return '买入';
            }
            // 死叉：DIF下穿DEA
            if (prevDif >= prevDea && lastDif < lastDea) {
                return '卖出';
            }
            // DIF在DEA上方，且MACD柱状图为正
            if (lastDif > lastDea && lastDif > 0) {
                return '买入';
            }
            // DIF在DEA下方，且MACD柱状图为负
            if (lastDif < lastDea && lastDif < 0) {
                return '卖出';
            }
            
            return '观望';
        }
        
        // 分析RSI指标
        function analyzeRSI(rsiData) {
            if (!rsiData || rsiData.length === 0) return '观望';
            
            const lastRSI = parseFloat(rsiData[rsiData.length - 1]);
            
            if (lastRSI > 70) {
                return '卖出';
            } else if (lastRSI < 30) {
                return '买入';
            } else if (lastRSI > 50) {
                return '买入';
            } else {
                return '卖出';
            }
        }
        
        // 分析KDJ指标
        function analyzeKDJ(kdjResult) {
            const k = kdjResult.k;
            const d = kdjResult.d;
            const j = kdjResult.j;
            
            if (k.length < 2) return '观望';
            
            const lastK = parseFloat(k[k.length - 1]);
            const lastD = parseFloat(d[d.length - 1]);
            const lastJ = parseFloat(j[j.length - 1]);
            const prevK = parseFloat(k[k.length - 2]);
            const prevD = parseFloat(d[d.length - 2]);
            
            // 金叉：K上穿D
            if (prevK <= prevD && lastK > lastD) {
                return '买入';
            }
            // 死叉：K下穿D
            if (prevK >= prevD && lastK < lastD) {
                return '卖出';
            }
            // J值判断
            if (lastJ > 100) {
                return '卖出';
            } else if (lastJ < 0) {
                return '买入';
            }
            
            return '观望';
        }
        
        // 分析BOLL指标
        function analyzeBOLL(bollResult, klineData) {
            const upper = bollResult.upper;
            const middle = bollResult.ma;
            const lower = bollResult.lower;
            
            if (!upper || upper.length === 0) return '观望';
            
            const lastIndex = upper.length - 1;
            const lastUpper = parseFloat(upper[lastIndex]);
            const lastMiddle = parseFloat(middle[lastIndex]);
            const lastLower = parseFloat(lower[lastIndex]);
            const lastClose = parseFloat(klineData[lastIndex][1]);
            
            // 价格突破上轨
            if (lastClose > lastUpper) {
                return '买入';
            }
            // 价格跌破下轨
            if (lastClose < lastLower) {
                return '卖出';
            }
            // 价格在中轨上方
            if (lastClose > lastMiddle) {
                return '买入';
            }
            // 价格在中轨下方
            if (lastClose < lastMiddle) {
                return '卖出';
            }
            
            return '观望';
        }
        
        // 综合分析
        function analyzeComposite(singleResult) {
            const buySignals = Object.values(singleResult).filter(s => s === '买入').length;
            const sellSignals = Object.values(singleResult).filter(s => s === '卖出').length;
            
            if (buySignals >= 3) {
                return '买入';
            } else if (sellSignals >= 3) {
                return '卖出';
            } else if (buySignals > sellSignals) {
                return '买入';
            } else if (sellSignals > buySignals) {
                return '卖出';
            } else {
                return '观望';
            }
        }
        
        // 计算MACD
        function calculateMACD(data, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const ema12 = [];
            const ema26 = [];
            const dif = [];
            const dea = [];
            const macd = [];
            
            // 计算EMA12和EMA26
            for (let i = 0; i < data.length; i++) {
                const close = data[i][1];
                
                if (i === 0) {
                    ema12.push(close);
                    ema26.push(close);
                } else {
                    const k12 = 2 / (fastPeriod + 1);
                    const k26 = 2 / (slowPeriod + 1);
                    ema12.push((close - ema12[i - 1]) * k12 + ema12[i - 1]);
                    ema26.push((close - ema26[i - 1]) * k26 + ema26[i - 1]);
                }
                
                dif.push(ema12[i] - ema26[i]);
            }
            
            // 计算DEA和MACD
            for (let i = 0; i < dif.length; i++) {
                if (i === 0) {
                    dea.push(dif[i]);
                } else {
                    const k = 2 / (signalPeriod + 1);
                    dea.push((dif[i] - dea[i - 1]) * k + dea[i - 1]);
                }
                macd.push((dif[i] - dea[i]) * 2);
            }
            
            return { dif, dea, macd };
        }
        
        // 存储当前数据
        let currentStockData = null;
        let currentKlineData = null;
        let currentVolumeData = null;
        let currentDates = null;
        let currentChineseDates = null;
        let currentMAData = null;
        let currentVolumeMAData = null;
        let currentMACDData = null;
        let currentRSIData = null;
        let currentKDJData = null;
        let currentBOLLData = null;
        
        // 获取股票数据
        function fetchStockData() {
            if (!chart) {
                document.getElementById('error-message').textContent = '图表未初始化，请刷新页面重试';
                return;
            }
            
            // 检查是否正在请求中
            if (isRequesting) {
                document.getElementById('error-message').textContent = '提示: 正在获取数据，请稍后再试';
                return;
            }
            
            const symbol = document.getElementById('stock-symbol').value;
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = '';
            
            // 判断输入的是股票代码还是公司名称，如果是公司名称则转换为股票代码
            let stockCode = symbol;
            const stockName = getStockName(symbol);
            const codeFromName = getStockCode(symbol);
            
            if (codeFromName) {
                // 输入的是公司名称，转换为股票代码
                stockCode = codeFromName;
            }
            
            try {
                // 设置请求状态为正在请求
                isRequesting = true;
                
                // 显示加载状态
                chart.setOption({
                    title: {
                        text: `股票K线图 - ${stockCode} (加载中...)`
                    }
                });
                
                // 调用后端API，增加超时设置
                axios.get(`http://localhost:5001/api/stock/kline/${stockCode}`, {
                    timeout: 30000 // 30秒超时
                })
                    .then(response => {
                        // 设置请求状态为完成
                        isRequesting = false;
                        
                        if (response.data.success) {
                            const data = response.data.data;
                            
                            // 处理数据
                            const dates = [];
                            const klineData = [];
                            const chineseDates = [];
                            const volumeData = [];
                            
                            data.forEach(item => {
                                dates.push(item.date);
                                chineseDates.push(formatDateToChinese(item.date));
                                // 确保数据类型为数字，并按ECharts要求的顺序：[open, close, low, high]
                                klineData.push([
                                    parseFloat(item.open),
                                    parseFloat(item.close),
                                    parseFloat(item.low),
                                    parseFloat(item.high)
                                ]);
                                // 提取成交量数据
                                volumeData.push(parseFloat(item.volume));
                            });
                            
                            // 计算MA
                            const ma5 = calculateMA(klineData, 5);
                            const ma10 = calculateMA(klineData, 10);
                            const ma20 = calculateMA(klineData, 20);
                            const ma30 = calculateMA(klineData, 30);
                            const ma60 = calculateMA(klineData, 60);
                            
                            // 计算成交量均线
                            const volMA5 = calculateVolumeMA(volumeData, 5);
                            const volMA10 = calculateVolumeMA(volumeData, 10);
                            
                            // 计算MACD
                            const macdResult = calculateMACD(klineData);
                            
                            // 计算KDJ
                            const kdjResult = calculateKDJ(klineData);
                            
                            // 计算RSI
                            const rsi14 = calculateRSI(klineData, 14);
                            
                            // 计算BOLL
                            const bollResult = calculateBOLL(klineData);
                            currentBOLLData = bollResult;
                            
                            // 计算技术指标分析结果
                            const titleText = `股票K线图 - ${stockCode}`;
                            const singleResult = {
                                'MACD': analyzeMACD(macdResult),
                                'RSI': analyzeRSI(rsi14),
                                'KDJ': analyzeKDJ(kdjResult),
                                'BOLL': analyzeBOLL(bollResult, klineData)
                            };
                            const compositeResult = analyzeComposite(singleResult);
                            
                            // 更新图表
                            chart.setOption({
                                title: [
                                    {
                                        text: titleText,
                                        left: 'center',
                                        top: '5%',
                                        subtext: `综合判断: ${compositeResult} | 买入信号: ${Object.values(singleResult).filter(s => s === '买入').length} | 卖出信号: ${Object.values(singleResult).filter(s => s === '卖出').length}`,
                                        subtextStyle: {
                                            fontSize: 12,
                                            color: compositeResult === '买入' ? '#4CAF50' : compositeResult === '卖出' ? '#f44336' : '#ff9800'
                                        }
                                    },
                                    {
                                        text: 'MA',
                                        left: '28%',
                                        top: '32%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 12,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'MACD',
                                        left: '78%',
                                        top: '32%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 12,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'VOL',
                                        left: '28%',
                                        top: '50%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 12,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'KDJ',
                                        left: '78%',
                                        top: '50%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 12,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'RSI',
                                        left: '28%',
                                        top: '68%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 12,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'BOLL',
                                        left: '78%',
                                        top: '68%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 12,
                                            fontWeight: 'bold'
                                        }
                                    }
                                ],
                                
                                
                                
                                
                                
                                tooltip: {
                                    trigger: 'axis',
                                    axisPointer: {
                                        type: 'cross'
                                    },
                                    formatter: function(params) {
                                        const index = params[0].dataIndex;
                                        let result = chineseDates[index] + '<br/>';
                                        
                                        // 处理K线数据
                                        if (params[0].seriesName === 'K线') {
                                            const data = params[0].data;
                                            result += `开盘: ${data[0]}<br/>`;
                                            result += `收盘: ${data[1]}<br/>`;
                                            result += `最低: ${data[2]}<br/>`;
                                            result += `最高: ${data[3]}<br/>`;
                                        }
                                        
                                        // 处理MA数据
                                        params.forEach(param => {
                                            if (param.seriesName.includes('MA')) {
                                                result += `${param.seriesName}: ${param.value}<br/>`;
                                            }
                                        });
                                        
                                        // 处理成交量数据
                                        params.forEach(param => {
                                            if (param.seriesName === '成交量' || param.seriesName.includes('VOL')) {
                                                result += `${param.seriesName}: ${param.value}<br/>`;
                                            }
                                        });
                                        
                                        // 处理MACD数据
                                        const hasMACD = params.some(param => param.seriesName === 'DIF' || param.seriesName === 'DEA' || param.seriesName === 'MACD');
                                        if (hasMACD) {
                                            result += '<br/><b>MACD指标说明:</b><br/>';
                                            result += 'DIF: 快速与慢速移动平均线的差<br/>';
                                            result += 'DEA: DIF的移动平均线<br/>';
                                            result += 'MACD: (DIF-DEA)×2，反映动量变化<br/>';
                                            result += '金叉: DIF上穿DEA，可能的买入信号<br/>';
                                            result += '死叉: DIF下穿DEA，可能的卖出信号<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'DIF' || param.seriesName === 'DEA' || param.seriesName === 'MACD') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理RSI数据
                                        const hasRSI = params.some(param => param.seriesName === 'RSI14');
                                        if (hasRSI) {
                                            result += '<br/><b>RSI指标说明:</b><br/>';
                                            result += '相对强弱指标，取值范围0-100<br/>';
                                            result += 'RSI > 70: 超买区域，可能回调<br/>';
                                            result += 'RSI < 30: 超卖区域，可能反弹<br/>';
                                            result += 'RSI在50左右: 市场处于平衡状态<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'RSI14') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理KDJ数据
                                        const hasKDJ = params.some(param => param.seriesName === 'K' || param.seriesName === 'D' || param.seriesName === 'J');
                                        if (hasKDJ) {
                                            result += '<br/><b>KDJ指标说明:</b><br/>';
                                            result += 'K线: 快速随机指标<br/>';
                                            result += 'D线: 慢速随机指标<br/>';
                                            result += 'J线: K和D的乖离率<br/>';
                                            result += '金叉: K上穿D，可能的买入信号<br/>';
                                            result += '死叉: K下穿D，可能的卖出信号<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'K' || param.seriesName === 'D' || param.seriesName === 'J') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理BOLL数据
                                        const hasBOLL = params.some(param => param.seriesName.includes('BOLL'));
                                        if (hasBOLL) {
                                            result += '<br/><b>BOLL指标说明:</b><br/>';
                                            result += '上轨: 价格波动的压力线<br/>';
                                            result += '中轨: 价格的移动平均线<br/>';
                                            result += '下轨: 价格波动的支撑线<br/>';
                                            result += '价格突破上轨: 可能继续上涨<br/>';
                                            result += '价格突破下轨: 可能继续下跌<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName.includes('BOLL')) {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        return result;
                                    }
                                },
                                legend: {
                                    data: ['K线', 'MA5', 'MA10', 'MA20', 'MA30', 'MA60', '成交量', 'VOL5', 'VOL10', 'DIF', 'DEA', 'MACD', 'RSI14', 'K', 'D', 'J', 'BOLL上轨', 'BOLL中轨', 'BOLL下轨'],
                                    top: 40,
                                    type: 'scroll',
                                    textStyle: {
                                        fontSize: 10
                                    }
                                },
                                dataZoom: [
                                    {
                                        type: 'inside',
                                        start: 0,
                                        end: 100,
                                        xAxisIndex: [0, 1, 2, 3, 4, 5, 6]
                                    },
                                    {
                                        show: true,
                                        type: 'slider',
                                        bottom: '0%',
                                        start: 0,
                                        end: 100,
                                        xAxisIndex: [0, 1, 2, 3, 4, 5, 6]
                                    }
                                ],
                                
                                grid: [
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '10%',
                                        height: '18%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '53%',
                                        top: '34%',
                                        height: '14%',
                                        containLabel: true
                                    },
                                    {
                                        left: '53%',
                                        right: '4%',
                                        top: '34%',
                                        height: '14%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '53%',
                                        top: '52%',
                                        height: '14%',
                                        containLabel: true
                                    },
                                    {
                                        left: '53%',
                                        right: '4%',
                                        top: '52%',
                                        height: '14%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '53%',
                                        top: '70%',
                                        height: '14%',
                                        containLabel: true
                                    },
                                    {
                                        left: '53%',
                                        right: '4%',
                                        top: '70%',
                                        height: '14%',
                                        containLabel: true
                                    }
                                ],
                                xAxis: [
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 1,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 2,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 3,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 4,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 5,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 6,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    }
                                ],
                                yAxis: [
                                    {
                                        type: 'value',
                                        scale: true,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 1,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 2,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 3,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 4,
                                        min: 0,
                                        max: 100,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 5,
                                        min: 0,
                                        max: 100,
                                        splitArea: {
                                            show: true
                                        }
                                    },
                                    {
                                        type: 'value',
                                        scale: true,
                                        gridIndex: 6,
                                        splitArea: {
                                            show: true
                                        }
                                    }
                                ],
                                
                                series: [
                                    {
                                        name: 'K线',
                                        type: 'candlestick',
                                        data: klineData,
                                        itemStyle: {
                                            color: '#ef5350',
                                            color0: '#26a69a',
                                            borderColor: '#ef5350',
                                            borderColor0: '#26a69a'
                                        }
                                    },
                                    {
                                        name: 'MA5',
                                        type: 'line',
                                        data: ma5,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'MA10',
                                        type: 'line',
                                        data: ma10,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'MA20',
                                        type: 'line',
                                        data: ma20,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#9C27B0'
                                        }
                                    },
                                    {
                                        name: 'MA30',
                                        type: 'line',
                                        data: ma30,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#795548'
                                        }
                                    },
                                    {
                                        name: 'MA60',
                                        type: 'line',
                                        data: ma60,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#607D8B'
                                        }
                                    },
                                    {
                                        name: '成交量',
                                        type: 'bar',
                                        xAxisIndex: 3,
                                        yAxisIndex: 3,
                                        data: volumeData,
                                        itemStyle: {
                                            color: function(params) {
                                                // 根据收盘价与开盘价的比较设置成交量颜色
                                                const klineItem = klineData[params.dataIndex];
                                                return klineItem[1] >= klineItem[0] ? '#ef5350' : '#26a69a';
                                            }
                                        }
                                    },
                                    {
                                        name: 'VOL5',
                                        type: 'line',
                                        xAxisIndex: 3,
                                        yAxisIndex: 3,
                                        data: volMA5,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'VOL10',
                                        type: 'line',
                                        xAxisIndex: 3,
                                        yAxisIndex: 3,
                                        data: volMA10,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'DIF',
                                        type: 'line',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.dif.map(val => val.toFixed(4)),
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'DEA',
                                        type: 'line',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.dea.map(val => val.toFixed(4)),
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'MACD',
                                        type: 'bar',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.macd.map(val => val.toFixed(4)),
                                        itemStyle: {
                                            color: function(params) {
                                                return params.value >= 0 ? '#ef5350' : '#26a69a';
                                            }
                                        }
                                    },
                                    {
                                        name: 'K',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.k,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'D',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.d,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'J',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.j,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#4CAF50'
                                        }
                                    },
                                    {
                                        name: 'MA5',
                                        type: 'line',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: ma5,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'MA10',
                                        type: 'line',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: ma10,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'MA20',
                                        type: 'line',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: ma20,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#9C27B0'
                                        }
                                    },
                                    {
                                        name: 'MA30',
                                        type: 'line',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: ma30,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#795548'
                                        }
                                    },
                                    {
                                        name: 'MA60',
                                        type: 'line',
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        data: ma60,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#607D8B'
                                        }
                                    },
                                    {
                                        name: 'RSI14',
                                        type: 'line',
                                        xAxisIndex: 5,
                                        yAxisIndex: 5,
                                        data: rsi14,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'BOLL上轨',
                                        type: 'line',
                                        xAxisIndex: 6,
                                        yAxisIndex: 6,
                                        data: bollResult.upper,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF9800'
                                        }
                                    },
                                    {
                                        name: 'BOLL中轨',
                                        type: 'line',
                                        xAxisIndex: 6,
                                        yAxisIndex: 6,
                                        data: bollResult.ma,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#2196F3'
                                        }
                                    },
                                    {
                                        name: 'BOLL下轨',
                                        type: 'line',
                                        xAxisIndex: 6,
                                        yAxisIndex: 6,
                                        data: bollResult.lower,
                                        smooth: true,
                                        symbol: 'none',
                                        lineStyle: {
                                            width: 1,
                                            color: '#4CAF50'
                                        }
                                    }
                                ]
                            });
                        } else {
                            errorMessage.textContent = `错误: ${response.data.error}`;
                        }
                    })
                    .catch(error => {
                        // 设置请求状态为完成
                        isRequesting = false;
                        
                        if (error.code === 'ECONNABORTED') {
                            errorMessage.textContent = '错误: 请求超时，请稍后再试';
                        } else if (error.message.includes('Network Error')) {
                            errorMessage.textContent = '错误: 网络连接失败，请检查后端服务是否运行';
                        } else if (error.message.includes('ERR_ABORTED')) {
                            errorMessage.textContent = '错误: 请求被中止，可能是网络连接问题，请稍后再试';
                        } else if (error.response) {
                            // 后端返回了错误响应
                            if (error.response.status === 500) {
                                errorMessage.textContent = '错误: 后端服务处理失败，可能是外部API连接问题';
                            } else {
                                errorMessage.textContent = `错误: ${error.response.status} - ${error.response.statusText}`;
                            }
                        } else {
                            errorMessage.textContent = `请求失败: ${error.message}`;
                        }
                    });
            } catch (error) {
                // 设置请求状态为完成
                isRequesting = false;
                
                errorMessage.textContent = `获取数据错误: ${error.message}`;
                console.error('获取数据错误:', error);
            }
        }
        

    </script>
</body>
</html>