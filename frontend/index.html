<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票K线可视化</title>
    <!-- 引入ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- 引入Axios -->
    <script src="https://cdn.bootcdn.net/ajax/libs/axios/1.6.2/axios.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000000;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        
        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Page Navigation */
        .page-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px;
            background-color: #121212;
            border-bottom: 1px solid #333;
        }
        
        .page-nav button {
            padding: 10px 30px;
            font-size: 16px;
            font-weight: bold;
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 2px solid #333;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .page-nav button:hover {
            background-color: #2a2a2a;
            border-color: #555;
        }
        
        .page-nav button.active {
            background-color: #ff3333;
            color: #ffffff;
            border-color: #ff3333;
        }
        
        /* Page Containers */
        .page {
            display: none;
            animation: fadeIn 0.3s ease;
            min-height: calc(100vh - 70px);
        }
        
        .page.active {
            display: block !important;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Stock Data Area */
        .stock-container {
            flex: 1;
            width: 100%;
            min-width: 0;
            padding: 20px;
            background-color: #000000;
            overflow-y: auto;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Header */
        .stock-header {
            background-color: #121212;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        
        .stock-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .stock-name {
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .stock-price {
            font-size: 24px;
            font-weight: bold;
            color: #ff3333; /* Red for Up */
        }
        
        .stock-meta {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 12px;
            color: #b0b0b0;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
        }
        
        .meta-label {
            color: #888;
        }
        
        .meta-value {
            color: #e0e0e0;
            font-weight: 500;
        }
        
        /* Input Section */
        .input-section {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .input-section input {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            font-size: 14px;
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .input-section input:focus {
            outline: none;
            border-color: #ff3333;
            box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.2);
        }
        
        .input-section button {
            padding: 10px 20px;
            font-size: 14px;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .input-section button:hover {
            background-color: #444;
            border-color: #666;
        }
        
        /* Search Results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 20px;
            right: 20px;
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }
        
        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        
        .search-result-item:hover {
            background-color: #333;
        }
        
        .stock-code {
            font-weight: bold;
            color: #ff3333;
        }
        
        /* Chart Container */
        #chart-container {
            width: 100%;
            height: 800px;
            background-color: #121212;
            border-radius: 4px;
            padding: 10px;
            border: 1px solid #333;
        }
        
        /* Indicator Guide */
        .indicator-guide {
            margin-top: 20px;
            background-color: #121212;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        
        .indicator-guide h2 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .indicator-item {
            padding: 12px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: #1e1e1e;
        }
        
        .indicator-item h3 {
            color: #ff3333;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .indicator-item p {
            font-size: 12px;
            color: #b0b0b0;
            line-height: 1.4;
        }
        
        /* AI Sidebar */
        .ai-sidebar {
            position: relative;
            width: 0;
            height: 100vh;
            background-color: #1e1e1e;
            box-shadow: -4px 0 10px rgba(0,0,0,0.5);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #333;
            overflow: hidden;
        }
        
        .ai-sidebar.open {
            width: 450px;
        }

        /* AI Report Area */
        .ai-report-container {
            flex: 1.5;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #333;
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        /* AI Header in Sidebar */
        .ai-header {
            background-color: #252525;
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-title {
            font-size: 18px;
            font-weight: bold;
            color: #ffffff;
        }
        
        .close-sidebar {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
        }
        
        .close-sidebar:hover {
            color: #fff;
        }
        
        /* AI Trigger Button */
        .ai-trigger {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background-color: #252525;
            color: #fff;
            padding: 15px 8px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            z-index: 1999;
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 4px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
            border: 1px solid #333;
            border-right: none;
            transition: right 0.3s ease, background-color 0.2s;
            font-size: 14px;
        }
        
        .ai-trigger:hover {
            background-color: #333;
            color: #ff3333;
        }
        
        /* Chat Window in Sidebar */
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            min-height: 0;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            min-height: 0;
        }
        
        .chat-message {
            margin-bottom: 15px;
            max-width: 90%;
        }
        
        .chat-message.ai {
            align-self: flex-start;
        }
        
        .chat-message.user {
            align-self: flex-end;
            margin-left: auto;
        }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .ai .message-bubble {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-bottom-left-radius: 4px;
            border: 1px solid #333;
        }
        
        .user .message-bubble {
            background-color: #ff3333;
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-time {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
            text-align: right;
        }
        
        /* Chat Input */
        .chat-input {
            padding: 15px;
            border-top: 1px solid #333;
            background-color: #252525;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
        }
        
        .chat-input-area input {
            flex: 1;
            padding: 10px 15px;
            background-color: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .chat-input-area input:focus {
            outline: none;
            border-color: #ff3333;
        }
        
        .chat-input-area button {
            padding: 0 20px;
            background-color: #ff3333;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        
        .chat-input-area button:hover {
            background-color: #d32f2f;
        }
        
        /* Loading */
        .loading-indicator {
            display: none;
            padding: 15px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #333;
            border-top: 2px solid #ff3333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #ff3333;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Curve Analysis Styles */
        .editor-container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #333;
        }

        #curveEditor {
            border: 1px solid #333;
            background-color: #252525;
            cursor: crosshair;
            border-radius: 4px;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
        }

        .curve-btn {
            padding: 10px 24px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .btn-primary { background-color: #ff3333; color: white; }
        .btn-primary:hover { background-color: #d32f2f; transform: translateY(-1px); }

        .btn-secondary { background-color: #333; color: #e0e0e0; border: 1px solid #444; }
        .btn-secondary:hover { background-color: #444; }

        .chart-box { 
            height: 300px; 
            background: #1e1e1e;
            border-radius: 8px;
            border: 1px solid #333;
            padding: 15px;
        }

        .row { display: flex; gap: 20px; margin-top: 20px; }
        .col { flex: 1; min-width: 0; }

        #latency { font-weight: bold; color: #4caf50; margin-left: 10px; }

        .helper-text { font-size: 0.9em; color: #888; margin-top: 5px; }

        /* Favorites Shelf */
        .favorites-trigger {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #252525;
            color: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1500;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .favorites-trigger:hover {
            background-color: #333;
            color: #ff3333;
        }

        .favorites-panel {
            position: fixed;
            top: 60px;
            right: 20px;
            width: 300px;
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1500;
            display: none;
            flex-direction: column;
            max-height: 80vh;
        }

        .favorites-panel.open {
            display: flex;
        }

        .favorites-header {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .favorites-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px 0;
        }

        .favorite-item {
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .favorite-item:hover {
            background-color: #2a2a2a;
        }

        .favorite-info {
            display: flex;
            flex-direction: column;
        }

        .favorite-code {
            font-weight: bold;
            color: #ff3333;
        }

        .favorite-name {
            font-size: 12px;
            color: #aaa;
        }

        .favorite-actions button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
        }

        .favorite-actions button:hover {
            color: #ff3333;
        }

        .favorites-footer {
            padding: 10px;
            border-top: 1px solid #333;
            display: flex;
            gap: 10px;
        }

        .favorites-footer button {
            flex: 1;
            padding: 6px;
            font-size: 12px;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
        }

        .favorites-footer button:hover {
            background-color: #444;
        }

        /* Match Action Buttons */
        .match-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: center;
        }

        .match-btn {
            padding: 4px 8px;
            font-size: 12px;
            background-color: #333;
            color: #ccc;
            border: 1px solid #444;
            border-radius: 3px;
            cursor: pointer;
        }

        .match-btn:hover {
            background-color: #444;
            color: white;
        }
    </style>
</head>
<body>
    <!-- 页面导航 -->
    <div class="page-nav">
        <button class="page-nav-btn active" data-page="stock-analysis">股市分析</button>
        <button class="page-nav-btn" data-page="curve-analysis">曲线匹配</button>
    </div>

    <!-- 收藏夹入口 -->
    <div class="favorites-trigger" onclick="toggleFavorites()">
        <span>★ 收藏架</span>
    </div>

    <!-- 收藏夹面板 -->
    <div class="favorites-panel" id="favorites-panel">
        <div class="favorites-header">
            <span>我的收藏</span>
            <button class="close-sidebar" onclick="toggleFavorites()">×</button>
        </div>
        <div class="favorites-list" id="favorites-list">
            <!-- Favorites will be rendered here -->
            <div style="padding: 20px; text-align: center; color: #666;">暂无收藏</div>
        </div>
        <div class="favorites-footer">
            <button onclick="exportFavorites()">导出</button>
            <button onclick="document.getElementById('import-file').click()">导入</button>
        </div>
        <input type="file" id="import-file" style="display: none" accept=".json" onchange="importFavorites(this)">
    </div>

    <!-- 股市分析页面 -->
    <div id="stock-analysis" class="page active">
        <div class="main-container">
            <!-- 左侧股票数据区域 -->
            <div class="stock-container">
            <!-- 顶部股票信息栏 -->
            <div class="stock-header">
                <div class="stock-info">
                    <div style="display: flex; align-items: center;">
                        <div class="stock-name" id="stock-name">平安银行 (000001)</div>
                        <button id="fav-btn-main" class="match-btn" onclick="addCurrentToFavorites()" style="margin-left: 15px; font-size: 14px; padding: 5px 10px; background-color: #333; color: #fff; border: 1px solid #555;">★ 收藏</button>
                    </div>
                    <div class="stock-price" id="stock-price">11.07</div>
                </div>
                <div class="stock-meta">
                    <div class="meta-item" title="最高价：当日最高成交价">
                        <span class="meta-label">高</span>
                        <span class="meta-value" id="stock-high">11.11</span>
                    </div>
                    <div class="meta-item" title="最低价：当日最低成交价">
                        <span class="meta-label">低</span>
                        <span class="meta-value" id="stock-low">11.01</span>
                    </div>
                    <div class="meta-item" title="开盘价：当日第一笔成交价">
                        <span class="meta-label">开</span>
                        <span class="meta-value" id="stock-open">11.05</span>
                    </div>
                    <div class="meta-item" title="成交量：当日成交股票数量">
                        <span class="meta-label">量</span>
                        <span class="meta-value" id="stock-volume">6197万</span>
                    </div>
                </div>
            </div>
            
            <!-- 输入区域 -->
            <div class="input-section" style="position: relative;">
                <input type="text" id="stock-symbol" placeholder="输入股票代码或名称，例如：000001 或 浦发银行" value="000001" oninput="handleSearchInput(this.value)">
                <button onclick="fetchStockData()">获取数据</button>
                <div class="search-results" id="search-results"></div>
            </div>
            
            <!-- 图表容器 -->
            <div id="chart-container"></div>
            
            <!-- 技术指标参考指南 -->
            <div class="indicator-guide">
                <h2>技术指标参考指南</h2>
                <div class="indicator-grid">
                    <div class="indicator-item">
                        <h3>MA（移动平均线）</h3>
                        <p>构成：5日、10日、20日、30日均线等</p>
                        <p>金叉：短周期均线上穿长周期均线，买入信号</p>
                        <p>死叉：短周期均线下穿长周期均线，卖出信号</p>
                    </div>
                    <div class="indicator-item">
                        <h3>VOL（成交量）</h3>
                        <p>成交量是指股票在一定时间内的成交数量，反映市场的活跃度和资金流向。</p>
                        <p>价升量增：上涨趋势可能持续</p>
                        <p>价升量减：上涨动力不足，可能回调</p>
                    </div>
                    <div class="indicator-item">
                        <h3>MACD（指数平滑异同移动平均线）</h3>
                        <p>构成：DIF（快线）、DEA（慢线）、MACD柱状图</p>
                        <p>金叉：DIF上穿DEA，买入信号</p>
                        <p>死叉：DIF下穿DEA，卖出信号</p>
                    </div>
                    <div class="indicator-item">
                        <h3>RSI（相对强弱指标）</h3>
                        <p>取值范围：0-100</p>
                        <p>RSI > 70：超买区域，可能回调</p>
                        <p>RSI < 30：超卖区域，可能反弹</p>
                    </div>
                    <div class="indicator-item">
                        <h3>KDJ（随机指标）</h3>
                        <p>构成：K线（快速线）、D线（慢速线）、J线（确认线）</p>
                        <p>金叉：K线上穿D线，买入信号</p>
                        <p>死叉：K线下穿D线，卖出信号</p>
                    </div>
                    <div class="indicator-item">
                        <h3>BOLL（布林带）</h3>
                        <p>构成：上轨、中轨（移动平均线）、下轨</p>
                        <p>价格突破上轨：可能继续上涨，或回调</p>
                        <p>价格突破下轨：可能继续下跌，或反弹</p>
                    </div>
                </div>
            </div>
            
            <div class="error-message" id="error-message"></div>
        </div>
        
        <!-- AI Sidebar & Trigger -->
        <div class="ai-trigger" onclick="toggleSidebar()">
            AI 智能分析
        </div>

        <div class="ai-sidebar" id="ai-sidebar">
            <div class="ai-header">
                <div class="ai-title">AI 智能分析</div>
                <button class="close-sidebar" onclick="toggleSidebar()">×</button>
            </div>
            
            <div class="ai-report-container" id="ai-report-container">
                <div style="color: #888; text-align: center; margin-top: 50px;">
                    <p>点击下方"分析当前股票价值"按钮</p>
                    <p>生成详细AI分析报告</p>
                </div>
            </div>
            
            <div class="loading-indicator" id="loading-indicator">
                <div class="loading-spinner"></div>
                正在分析中...
            </div>

            <div style="padding: 20px; border-top: 1px solid #333; background-color: #252525;">
                <button onclick="analyzeCurrentStock()" style="width: 100%; padding: 12px; background-color: #ff3333; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; transition: background-color 0.3s;">分析当前股票价值</button>
            </div>
        </div>
    </div>
    </div>

    <!-- 曲线分析页面 -->
    <div id="curve-analysis" class="page">
        <div style="padding: 20px; min-height: calc(100vh - 70px);">
            <h2 style="color: #ffffff; margin-bottom: 10px; text-align: center;">曲线匹配</h2>
            <p style="color: #888; margin-bottom: 30px; text-align: center;">绘制形状以查找最近20个交易日的相似股票模式。</p>
            
            <div class="editor-container">
                <h3 style="color: #e0e0e0; margin-bottom: 15px;">模式编辑器</h3>
                <canvas id="curveEditor" width="800" height="300"></canvas>
                <div class="helper-text">点击线条添加控制点。拖动点调整形状。双击点删除。</div>
                
                <div class="controls">
                    <button class="curve-btn btn-secondary" onclick="resetEditor()">重置线条</button>
                    <button class="curve-btn btn-primary" onclick="runCurveSearch()">匹配模式</button>
                    <span id="latency"></span>
                </div>
            </div>

            <h3 style="color: #e0e0e0; margin-bottom: 15px;">最佳3个匹配</h3>
            <div class="row">
                <div class="col">
                    <h4 id="match1-title" style="color: #e0e0e0; margin-bottom: 10px;">匹配1</h4>
                    <div id="match1" class="chart-box"></div>
                </div>
                <div class="col">
                    <h4 id="match2-title" style="color: #e0e0e0; margin-bottom: 10px;">匹配2</h4>
                    <div id="match2" class="chart-box"></div>
                </div>
                <div class="col">
                    <h4 id="match3-title" style="color: #e0e0e0; margin-bottom: 10px;">匹配3</h4>
                    <div id="match3" class="chart-box"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化ECharts实例
        let matchCharts = [];
        
        // 页面加载时初始化图表
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化匹配结果图表
            matchCharts = [
                echarts.init(document.getElementById('match1')),
                echarts.init(document.getElementById('match2')),
                echarts.init(document.getElementById('match3'))
            ];
        });

        let chart;
        let isRequesting = false; // 请求状态标志
        
        // 页面切换功能
        document.addEventListener('DOMContentLoaded', function() {
            const pageNavBtns = document.querySelectorAll('.page-nav-btn');
            const pages = document.querySelectorAll('.page');
            
            pageNavBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    
                    // 更新按钮状态
                    pageNavBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 切换页面
                    pages.forEach(page => {
                        page.classList.remove('active');
                        if (page.id === targetPage) {
                            page.classList.add('active');
                        }
                    });
                    
                    // 如果切换到股市分析页面，调整图表大小
                    if (targetPage === 'stock-analysis' && chart) {
                        setTimeout(() => {
                            chart.resize();
                        }, 100);
                    }
                    
                    // 如果切换到曲线分析页面，确保图表初始化
                    if (targetPage === 'curve-analysis') {
                        setTimeout(() => {
                            if (matchCharts.length === 0) {
                                matchCharts = [
                                    echarts.init(document.getElementById('match1')),
                                    echarts.init(document.getElementById('match2')),
                                    echarts.init(document.getElementById('match3'))
                                ];
                            }
                            // 调整图表大小
                            matchCharts.forEach(c => c.resize());
                        }, 100);
                    }
                });
            });
        });
        
        // 股票代码到公司名称的映射
        const stockNameMap = {
            '600036': '招商银行',
            '000001': '平安银行',
            '000002': '万科A',
            '600519': '贵州茅台',
            '601318': '中国平安',
            '600030': '中芯国际',
            '601888': '中国中车',
            '600000': '浦发银行',
            '601398': '工商银行',
            '601988': '中国银行',
            '600028': '中国石化',
            '601857': '中国石油'
        };
    
        
    
        
        // 当股票代码或公司名称输入时，显示对应信息
        function fetchStockName() {
            const input = document.getElementById('stock-symbol').value;
            const stockNameElement = document.getElementById('stock-name');
            
            // 判断输入的是股票代码还是公司名称
            const stockCode = input;
            const stockName = input;
            
            if (stockCode && !stockName) {
                // 输入的是公司名称，显示股票代码
                stockNameElement.textContent = `股票代码：${stockCode}`;
            } else if (stockName && !stockCode) {
                // 输入的是股票代码，显示公司名称
                stockNameElement.textContent = `（${stockName}）`;
            } else {
                stockNameElement.textContent = '';
            }
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            try {
                // 检查echarts是否加载
                if (typeof echarts === 'undefined') {
                    document.getElementById('error-message').textContent = 'ECharts库加载失败，请刷新页面重试';
                    return;
                }
                
                // 初始化图表
                chart = echarts.init(document.getElementById('chart-container'));
                
                // 配置项
                const option = {
                    title: {
                        text: '股票K线图',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    legend: {
                        data: ['K线'],
                        bottom: 10
                    },
                    dataZoom: [
                        {
                            type: 'inside',
                            start: 0,
                            end: 100,
                            zoomOnMouseWheel: true,
                            moveOnMouseMove: true,
                            moveOnMouseWheel: true
                        },
                        {
                            show: true,
                            type: 'slider',
                            bottom: '0%',
                            start: 0,
                            end: 100,
                            zoomOnMouseWheel: true
                        }
                    ],
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: [],
                        axisLabel: {
                            rotate: 45
                        }
                    },
                    yAxis: {
                        type: 'value',
                        scale: true
                    },
                    series: [
                        {
                            name: 'K线',
                            type: 'candlestick',
                            data: [],
                            itemStyle: {
                                color: '#ef5350',
                                color0: '#26a69a',
                                borderColor: '#ef5350',
                                borderColor0: '#26a69a'
                            },
                            // 调整蜡烛图样式，确保影线清晰可见
                            emphasis: {
                                itemStyle: {
                                    color: '#ff5722',
                                    color0: '#4caf50',
                                    borderColor: '#ff5722',
                                    borderColor0: '#4caf50'
                                }
                            }
                        }
                    ]
                };
                
                chart.setOption(option);
                
                // 延迟1秒获取数据，确保后端服务完全启动
                setTimeout(function() {
                    fetchStockData();
                }, 1000);
                
                // 响应式调整
                window.addEventListener('resize', function() {
                    if (chart) {
                        chart.resize();
                    }
                });
            } catch (error) {
                document.getElementById('error-message').textContent = `初始化错误: ${error.message}`;
                console.error('初始化错误:', error);
            }
        };
        
        // 计算移动平均线
        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j][1]; // close price
                }
                result.push((sum / period).toFixed(2));
            }
            return result;
        }
        
        // 将英文时间格式转换为中文格式
        function formatDateToChinese(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekday = weekdays[date.getDay()];
            return `${year}年${month}月${day}日 ${weekday}`;
        }
        
        // 计算成交量移动平均线
        function calculateVolumeMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push(null);
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j];
                }
                result.push((sum / period).toFixed(2));
            }
            return result;
        }
        
        // 计算RSI指标
        function calculateRSI(data, period = 14) {
            const result = [];
            let gains = [];
            let losses = [];
            
            // 计算每日涨跌幅度
            for (let i = 1; i < data.length; i++) {
                const change = data[i][1] - data[i-1][1];
                if (change > 0) {
                    gains.push(change);
                    losses.push(0);
                } else {
                    gains.push(0);
                    losses.push(Math.abs(change));
                }
            }
            
            // 计算RSI
            for (let i = 0; i < data.length; i++) {
                if (i < period) {
                    result.push(null);
                    continue;
                }
                
                // 计算平均 gain 和平均 loss
                let avgGain = 0;
                let avgLoss = 0;
                for (let j = 0; j < period; j++) {
                    avgGain += gains[i-1-j];
                    avgLoss += losses[i-1-j];
                }
                avgGain /= period;
                avgLoss /= period;
                
                // 计算RSI
                let rsi;
                if (avgLoss === 0) {
                    rsi = 100;
                } else {
                    const rs = avgGain / avgLoss;
                    rsi = 100 - (100 / (1 + rs));
                }
                
                result.push(rsi.toFixed(2));
            }
            
            return result;
        }
        
        // 计算KDJ指标
        function calculateKDJ(data, period = 9, kPeriod = 3, dPeriod = 3) {
            const lowList = [];
            const highList = [];
            const rsvList = [];
            const kList = [];
            const dList = [];
            const jList = [];
            
            // 计算每个周期的最高价和最低价
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    lowList.push(data[i][2]); // low
                    highList.push(data[i][3]); // high
                    rsvList.push(null);
                    kList.push(null);
                    dList.push(null);
                    jList.push(null);
                } else {
                    // 计算period周期内的最高价和最低价
                    let periodLow = Infinity;
                    let periodHigh = -Infinity;
                    for (let j = 0; j < period; j++) {
                        periodLow = Math.min(periodLow, data[i-j][2]);
                        periodHigh = Math.max(periodHigh, data[i-j][3]);
                    }
                    lowList.push(periodLow);
                    highList.push(periodHigh);
                    
                    // 计算RSV
                    const close = data[i][1];
                    let rsv;
                    if (periodHigh === periodLow) {
                        rsv = 50;
                    } else {
                        rsv = ((close - periodLow) / (periodHigh - periodLow)) * 100;
                    }
                    rsvList.push(rsv.toFixed(2));
                    
                    // 计算K、D、J
                    let k, d, j;
                    if (i === period - 1) {
                        // 第一个计算点
                        k = rsv;
                        d = rsv;
                    } else {
                        k = (2/3) * parseFloat(kList[i-1]) + (1/3) * rsv;
                        d = (2/3) * parseFloat(dList[i-1]) + (1/3) * k;
                    }
                    j = 3 * k - 2 * d;
                    
                    kList.push(k.toFixed(2));
                    dList.push(d.toFixed(2));
                    jList.push(j.toFixed(2));
                }
            }
            
            return { k: kList, d: dList, j: jList };
        }
        
        // 计算BOLL指标
        function calculateBOLL(data, period = 20, multiplier = 2) {
            const maList = [];
            const upperList = [];
            const lowerList = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    maList.push(null);
                    upperList.push(null);
                    lowerList.push(null);
                } else {
                    // 计算MA
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i-j][1]; // close
                    }
                    const ma = sum / period;
                    maList.push(ma.toFixed(2));
                    
                    // 计算标准差
                    let variance = 0;
                    for (let j = 0; j < period; j++) {
                        variance += Math.pow(data[i-j][1] - ma, 2);
                    }
                    const stdDev = Math.sqrt(variance / period);
                    
                    // 计算上轨和下轨
                    const upper = ma + multiplier * stdDev;
                    const lower = ma - multiplier * stdDev;
                    upperList.push(upper.toFixed(2));
                    lowerList.push(lower.toFixed(2));
                }
            }
            
            return { ma: maList, upper: upperList, lower: lowerList };
        }
        
        // 分析MACD指标
        function analyzeMACD(macdResult) {
            const dif = macdResult.dif;
            const dea = macdResult.dea;
            
            if (dif.length < 2) return '观望';
            
            const lastDif = parseFloat(dif[dif.length - 1]);
            const lastDea = parseFloat(dea[dea.length - 1]);
            const prevDif = parseFloat(dif[dif.length - 2]);
            const prevDea = parseFloat(dea[dea.length - 2]);
            
            // 金叉：DIF上穿DEA
            if (prevDif <= prevDea && lastDif > lastDea) {
                return '买入';
            }
            // 死叉：DIF下穿DEA
            if (prevDif >= prevDea && lastDif < lastDea) {
                return '卖出';
            }
            // DIF在DEA上方，且MACD柱状图为正
            if (lastDif > lastDea && lastDif > 0) {
                return '买入';
            }
            // DIF在DEA下方，且MACD柱状图为负
            if (lastDif < lastDea && lastDif < 0) {
                return '卖出';
            }
            
            return '观望';
        }
        
        // 分析RSI指标
        function analyzeRSI(rsiData) {
            if (!rsiData || rsiData.length === 0) return '观望';
            
            const lastRSI = parseFloat(rsiData[rsiData.length - 1]);
            
            if (lastRSI > 70) {
                return '卖出';
            } else if (lastRSI < 30) {
                return '买入';
            } else if (lastRSI > 50) {
                return '买入';
            } else {
                return '卖出';
            }
        }
        
        // 分析KDJ指标
        function analyzeKDJ(kdjResult) {
            const k = kdjResult.k;
            const d = kdjResult.d;
            const j = kdjResult.j;
            
            if (k.length < 2) return '观望';
            
            const lastK = parseFloat(k[k.length - 1]);
            const lastD = parseFloat(d[d.length - 1]);
            const lastJ = parseFloat(j[j.length - 1]);
            const prevK = parseFloat(k[k.length - 2]);
            const prevD = parseFloat(d[d.length - 2]);
            
            // 金叉：K上穿D
            if (prevK <= prevD && lastK > lastD) {
                return '买入';
            }
            // 死叉：K下穿D
            if (prevK >= prevD && lastK < lastD) {
                return '卖出';
            }
            // J值判断
            if (lastJ > 100) {
                return '卖出';
            } else if (lastJ < 0) {
                return '买入';
            }
            
            return '观望';
        }
        
        // 分析BOLL指标
        function analyzeBOLL(bollResult, klineData) {
            const upper = bollResult.upper;
            const middle = bollResult.ma;
            const lower = bollResult.lower;
            
            if (!upper || upper.length === 0) return '观望';
            
            const lastIndex = upper.length - 1;
            const lastUpper = parseFloat(upper[lastIndex]);
            const lastMiddle = parseFloat(middle[lastIndex]);
            const lastLower = parseFloat(lower[lastIndex]);
            const lastClose = parseFloat(klineData[lastIndex][1]);
            
            // 价格突破上轨
            if (lastClose > lastUpper) {
                return '买入';
            }
            // 价格跌破下轨
            if (lastClose < lastLower) {
                return '卖出';
            }
            // 价格在中轨上方
            if (lastClose > lastMiddle) {
                return '买入';
            }
            // 价格在中轨下方
            if (lastClose < lastMiddle) {
                return '卖出';
            }
            
            return '观望';
        }
        

        // 窗口大小改变时调整图表大小
        window.onresize = function() {
            matchCharts.forEach(c => c.resize());
            if (chart) chart.resize();
        };
        
        // 综合分析
        function analyzeComposite(singleResult) {
            const buySignals = Object.values(singleResult).filter(s => s === '买入').length;
            const sellSignals = Object.values(singleResult).filter(s => s === '卖出').length;
            
            if (buySignals >= 3) {
                return '买入';
            } else if (sellSignals >= 3) {
                return '卖出';
            } else if (buySignals > sellSignals) {
                return '买入';
            } else if (sellSignals > buySignals) {
                return '卖出';
            } else {
                return '观望';
            }
        }
        
        // 计算MACD
        function calculateMACD(data, fastPeriod = 12, slowPeriod = 26, signalPeriod = 9) {
            const ema12 = [];
            const ema26 = [];
            const dif = [];
            const dea = [];
            const macd = [];
            
            // 计算EMA12和EMA26
            for (let i = 0; i < data.length; i++) {
                const close = data[i][1];
                
                if (i === 0) {
                    ema12.push(close);
                    ema26.push(close);
                } else {
                    const k12 = 2 / (fastPeriod + 1);
                    const k26 = 2 / (slowPeriod + 1);
                    ema12.push((close - ema12[i - 1]) * k12 + ema12[i - 1]);
                    ema26.push((close - ema26[i - 1]) * k26 + ema26[i - 1]);
                }
                
                dif.push(ema12[i] - ema26[i]);
            }
            
            // 计算DEA和MACD
            for (let i = 0; i < dif.length; i++) {
                if (i === 0) {
                    dea.push(dif[i]);
                } else {
                    const k = 2 / (signalPeriod + 1);
                    dea.push((dif[i] - dea[i - 1]) * k + dea[i - 1]);
                }
                macd.push((dif[i] - dea[i]) * 2);
            }
            
            return { dif, dea, macd };
        }
        
        // 存储当前数据
        let currentStockData = null;
        let currentKlineData = null;
        let currentVolumeData = null;
        let currentDates = null;
        let currentChineseDates = null;
        let currentMAData = null;
        let currentVolumeMAData = null;
        let currentMACDData = null;
        let currentRSIData = null;
        let currentKDJData = null;
        let currentBOLLData = null;
        
        // 获取股票数据
        function fetchStockData() {
            if (!chart) {
                document.getElementById('error-message').textContent = '图表未初始化，请刷新页面重试';
                return;
            }
            
            // 检查是否正在请求中
            if (isRequesting) {
                document.getElementById('error-message').textContent = '提示: 正在获取数据，请稍后再试';
                return;
            }
            
            const symbol = document.getElementById('stock-symbol').value;
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = '';
            
            // 判断输入的是股票代码还是公司名称，如果是公司名称则转换为股票代码
            let stockCode = symbol;
            const stockName = symbol;
            const codeFromName = symbol;
            
            if (codeFromName) {
                // 输入的是公司名称，转换为股票代码
                stockCode = codeFromName;
            }
            
            try {
                // 设置请求状态为正在请求
                isRequesting = true;
                
                // 显示加载状态
                chart.setOption({
                    title: {
                        text: `股票K线图 - ${stockCode} (加载中...)`
                    }
                });
                
                // 调用后端API，增加超时设置
                axios.get(`http://localhost:5001/api/stock/kline/${stockCode}`, {
                    timeout: 30000 // 30秒超时
                })
                    .then(response => {
                        // 设置请求状态为完成
                        isRequesting = false;
                        
                        if (response.data.success) {
                            const data = response.data.data;
                            
                            // 处理数据
                            const dates = [];
                            const klineData = [];
                            const chineseDates = [];
                            const volumeData = [];
                            
                            data.forEach(item => {
                                dates.push(item.date);
                                chineseDates.push(formatDateToChinese(item.date));
                                // 确保数据类型为数字，并按ECharts要求的顺序：[open, close, low, high]
                                klineData.push([
                                    parseFloat(item.open),
                                    parseFloat(item.close),
                                    parseFloat(item.low),
                                    parseFloat(item.high)
                                ]);
                                // 提取成交量数据
                                volumeData.push(parseFloat(item.volume));
                            });
                            
                            // 计算MA
                            const ma5 = calculateMA(klineData, 5);
                            const ma10 = calculateMA(klineData, 10);
                            const ma20 = calculateMA(klineData, 20);
                            const ma30 = calculateMA(klineData, 30);
                            const ma60 = calculateMA(klineData, 60);
                            
                            // 计算成交量均线
                            const volMA5 = calculateVolumeMA(volumeData, 5);
                            const volMA10 = calculateVolumeMA(volumeData, 10);
                            
                            // 计算MACD
                            const macdResult = calculateMACD(klineData);
                            
                            // 计算KDJ
                            const kdjResult = calculateKDJ(klineData);
                            
                            // 计算RSI
                            const rsi14 = calculateRSI(klineData, 14);
                            
                            // 计算BOLL
                            const bollResult = calculateBOLL(klineData);
                            currentBOLLData = bollResult;
                            
                            // 计算技术指标分析结果
                            const titleText = `股票K线图 - ${stockCode}`;
                            const singleResult = {
                                'MACD': analyzeMACD(macdResult),
                                'RSI': analyzeRSI(rsi14),
                                'KDJ': analyzeKDJ(kdjResult),
                                'BOLL': analyzeBOLL(bollResult, klineData)
                            };
                            const compositeResult = analyzeComposite(singleResult);
                            
                            // 更新图表
                            chart.setOption({
                                title: [
                                    {
                                        text: titleText,
                                        left: 'center',
                                        top: '0%',
                                        subtext: `综合判断: ${compositeResult} | 买入信号: ${Object.values(singleResult).filter(s => s === '买入').length} | 卖出信号: ${Object.values(singleResult).filter(s => s === '卖出').length}`,
                                        subtextStyle: {
                                            fontSize: 12,
                                            color: compositeResult === '买入' ? '#4CAF50' : compositeResult === '卖出' ? '#f44336' : '#ff9800'
                                        }
                                    },
                                    {
                                        text: 'MA',
                                        left: '25%',
                                        top: '23%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 16,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'MACD',
                                        left: '75%',
                                        top: '23%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 16,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'VOL',
                                        left: '25%',
                                        top: '44%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 16,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'KDJ',
                                        left: '75%',
                                        top: '44%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 16,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'RSI',
                                        left: '25%',
                                        top: '66%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 16,
                                            fontWeight: 'bold'
                                        }
                                    },
                                    {
                                        text: 'BOLL',
                                        left: '75%',
                                        top: '66%',
                                        textAlign: 'center',
                                        textStyle: {
                                            fontSize: 16,
                                            fontWeight: 'bold'
                                        }
                                    }
                                ],
                                tooltip: {
                                    trigger: 'axis',
                                    axisPointer: {
                                        type: 'cross'
                                    },
                                    formatter: function(params) {
                                        const index = params[0].dataIndex;
                                        let result = chineseDates[index] + '<br/>';
                                        
                                        // 处理K线数据
                                        if (params[0].seriesName === 'K线') {
                                            const data = params[0].data;
                                            result += `开盘: ${data[0]}<br/>`;
                                            result += `收盘: ${data[1]}<br/>`;
                                            result += `最低: ${data[2]}<br/>`;
                                            result += `最高: ${data[3]}<br/>`;
                                        }
                                        
                                        // 处理MA数据
                                        params.forEach(param => {
                                            if (param.seriesName.includes('MA')) {
                                                result += `${param.seriesName}: ${param.value}<br/>`;
                                            }
                                        });
                                        
                                        // 处理成交量数据
                                        params.forEach(param => {
                                            if (param.seriesName === '成交量' || param.seriesName.includes('VOL')) {
                                                result += `${param.seriesName}: ${param.value}<br/>`;
                                            }
                                        });
                                        
                                        // 处理MACD数据
                                        const hasMACD = params.some(param => param.seriesName === 'DIF' || param.seriesName === 'DEA' || param.seriesName === 'MACD');
                                        if (hasMACD) {
                                            result += '<br/><b>MACD指标说明:</b><br/>';
                                            result += 'DIF: 快速与慢速移动平均线的差<br/>';
                                            result += 'DEA: DIF的移动平均线<br/>';
                                            result += 'MACD: (DIF-DEA)×2，反映动量变化<br/>';
                                            result += '金叉: DIF上穿DEA，可能的买入信号<br/>';
                                            result += '死叉: DIF下穿DEA，可能的卖出信号<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'DIF' || param.seriesName === 'DEA' || param.seriesName === 'MACD') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理RSI数据
                                        const hasRSI = params.some(param => param.seriesName === 'RSI14');
                                        if (hasRSI) {
                                            result += '<br/><b>RSI指标说明:</b><br/>';
                                            result += '相对强弱指标，取值范围0-100<br/>';
                                            result += 'RSI > 70: 超买区域，可能回调<br/>';
                                            result += 'RSI < 30: 超卖区域，可能反弹<br/>';
                                            result += 'RSI在50左右: 市场处于平衡状态<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'RSI14') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理KDJ数据
                                        const hasKDJ = params.some(param => param.seriesName === 'K' || param.seriesName === 'D' || param.seriesName === 'J');
                                        if (hasKDJ) {
                                            result += '<br/><b>KDJ指标说明:</b><br/>';
                                            result += 'K线: 快速随机指标<br/>';
                                            result += 'D线: 慢速随机指标<br/>';
                                            result += 'J线: K和D的乖离率<br/>';
                                            result += '金叉: K上穿D，可能的买入信号<br/>';
                                            result += '死叉: K下穿D，可能的卖出信号<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName === 'K' || param.seriesName === 'D' || param.seriesName === 'J') {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        // 处理BOLL数据
                                        const hasBOLL = params.some(param => param.seriesName.includes('BOLL'));
                                        if (hasBOLL) {
                                            result += '<br/><b>BOLL指标说明:</b><br/>';
                                            result += '上轨: 价格波动的压力线<br/>';
                                            result += '中轨: 价格的移动平均线<br/>';
                                            result += '下轨: 价格波动的支撑线<br/>';
                                            result += '价格突破上轨: 可能继续上涨<br/>';
                                            result += '价格突破下轨: 可能继续下跌<br/><br/>';
                                            params.forEach(param => {
                                                if (param.seriesName.includes('BOLL')) {
                                                    result += `${param.seriesName}: ${param.value}<br/>`;
                                                }
                                            });
                                        }
                                        
                                        return result;
                                    }
                                },
                                legend: [
                                    {
                                        data: [
                                            {name: 'MA5', icon: 'rect', itemStyle: {color: '#FF9800'}},
                                            {name: 'MA10', icon: 'rect', itemStyle: {color: '#2196F3'}},
                                            {name: 'MA20', icon: 'rect', itemStyle: {color: '#9C27B0'}},
                                            {name: 'MA30', icon: 'rect', itemStyle: {color: '#795548'}},
                                            {name: 'MA60', icon: 'rect', itemStyle: {color: '#607D8B'}}
                                        ],
                                        gridIndex: 1,
                                        top: '26%',
                                        left: '3%',
                                        itemWidth: 20,
                                        itemHeight: 3,
                                        textStyle: {
                                            fontSize: 10
                                        }
                                    },
                                    {
                                        data: [
                                            {name: 'DIF', icon: 'rect', itemStyle: {color: '#FF9800'}},
                                            {name: 'DEA', icon: 'rect', itemStyle: {color: '#2196F3'}},
                                            {name: 'MACD', icon: 'rect', itemStyle: {color: '#ef5350'}}
                                        ],
                                        gridIndex: 2,
                                        top: '26%',
                                        left: '53%',
                                        itemWidth: 20,
                                        itemHeight: 3,
                                        textStyle: {
                                            fontSize: 10
                                        }
                                    },
                                    {
                                        data: [
                                            {name: '成交量', icon: 'rect', itemStyle: {color: '#ef5350'}},
                                            {name: 'VOL5', icon: 'rect', itemStyle: {color: '#FF9800'}},
                                            {name: 'VOL10', icon: 'rect', itemStyle: {color: '#2196F3'}}
                                        ],
                                        gridIndex: 3,
                                        top: '47%',
                                        left: '3%',
                                        itemWidth: 20,
                                        itemHeight: 3,
                                        textStyle: {
                                            fontSize: 10
                                        }
                                    },
                                    {
                                        data: [
                                            {name: 'K', icon: 'rect', itemStyle: {color: '#FF9800'}},
                                            {name: 'D', icon: 'rect', itemStyle: {color: '#2196F3'}},
                                            {name: 'J', icon: 'rect', itemStyle: {color: '#4CAF50'}}
                                        ],
                                        gridIndex: 4,
                                        top: '47%',
                                        left: '53%',
                                        itemWidth: 20,
                                        itemHeight: 3,
                                        textStyle: {
                                            fontSize: 10
                                        }
                                    },
                                    {
                                        data: [
                                            {name: 'RSI14', icon: 'rect', itemStyle: {color: '#FF9800'}}
                                        ],
                                        gridIndex: 5,
                                        top: '69%',
                                        left: '3%',
                                        itemWidth: 20,
                                        itemHeight: 3,
                                        textStyle: {
                                            fontSize: 10
                                        }
                                    },
                                    {
                                        data: [
                                            {name: 'BOLL上轨', icon: 'rect', itemStyle: {color: '#FF9800'}},
                                            {name: 'BOLL中轨', icon: 'rect', itemStyle: {color: '#2196F3'}},
                                            {name: 'BOLL下轨', icon: 'rect', itemStyle: {color: '#4CAF50'}}
                                        ],
                                        gridIndex: 6,
                                        top: '69%',
                                        left: '53%',
                                        itemWidth: 20,
                                        itemHeight: 3,
                                        textStyle: {
                                            fontSize: 10
                                        }
                                    }
                                ],
                                dataZoom: [
                                    {
                                        type: 'inside',
                                        start: 0,
                                        end: 100,
                                        xAxisIndex: [0, 1, 2, 3, 4, 5, 6],
                                        zoomOnMouseWheel: true,
                                        moveOnMouseMove: true,
                                        moveOnMouseWheel: true
                                    },
                                    {
                                        show: true,
                                        type: 'slider',
                                        bottom: '0%',
                                        start: 0,
                                        end: 100,
                                        xAxisIndex: [0, 1, 2, 3, 4, 5, 6],
                                        zoomOnMouseWheel: true
                                    }
                                ],
                                grid: [
                                    {
                                        left: '3%',
                                        right: '4%',
                                        top: '6%',
                                        height: '16%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '53%',
                                        top: '29%',
                                        height: '12%',
                                        containLabel: true
                                    },
                                    {
                                        left: '53%',
                                        right: '4%',
                                        top: '29%',
                                        height: '12%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '53%',
                                        top: '50%',
                                        height: '12%',
                                        containLabel: true
                                    },
                                    {
                                        left: '53%',
                                        right: '4%',
                                        top: '50%',
                                        height: '12%',
                                        containLabel: true
                                    },
                                    {
                                        left: '3%',
                                        right: '53%',
                                        top: '72%',
                                        height: '12%',
                                        containLabel: true
                                    },
                                    {
                                        left: '53%',
                                        right: '4%',
                                        top: '72%',
                                        height: '12%',
                                        containLabel: true
                                    }
                                ],
                                xAxis: [
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 1,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 2,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 3,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 4,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 5,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'category',
                                        data: chineseDates,
                                        gridIndex: 6,
                                        axisLabel: {
                                            show: false
                                        },
                                        splitLine: {
                                            show: false
                                        }
                                    }
                                ],
                                yAxis: [
                                    {
                                        type: 'value',
                                        scale: true,
                                        splitArea: {
                                            show: true,
                                            areaStyle: {
                                                color: ['rgba(240, 240, 240, 0.1)', 'rgba(255, 255, 255, 0.1)']
                                            }
                                        }
                                    },
                                    {
                                        type: 'value',
                                        gridIndex: 1,
                                        splitLine: {
                                            show: false
                                        },
                                        min: function(value) {
                                            // 计算所有MA线条的最小值
                                            const allValues = [];
                                            if (typeof ma5 !== 'undefined') allValues.push(...ma5.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma10 !== 'undefined') allValues.push(...ma10.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma20 !== 'undefined') allValues.push(...ma20.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma30 !== 'undefined') allValues.push(...ma30.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma60 !== 'undefined') allValues.push(...ma60.filter(v => v !== null).map(v => parseFloat(v)));
                                            
                                            if (allValues.length === 0) return value.min;
                                            
                                            const min = Math.min(...allValues);
                                            const max = Math.max(...allValues);
                                            const range = max - min;
                                            
                                            // 确保有足够的空间，使线条之间的差距更明显
                                            return min - range * 0.1;
                                        },
                                        max: function(value) {
                                            // 计算所有MA线条的最大值
                                            const allValues = [];
                                            if (typeof ma5 !== 'undefined') allValues.push(...ma5.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma10 !== 'undefined') allValues.push(...ma10.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma20 !== 'undefined') allValues.push(...ma20.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma30 !== 'undefined') allValues.push(...ma30.filter(v => v !== null).map(v => parseFloat(v)));
                                            if (typeof ma60 !== 'undefined') allValues.push(...ma60.filter(v => v !== null).map(v => parseFloat(v)));
                                            
                                            if (allValues.length === 0) return value.max;
                                            
                                            const min = Math.min(...allValues);
                                            const max = Math.max(...allValues);
                                            const range = max - min;
                                            
                                            // 确保有足够的空间，使线条之间的差距更明显
                                            return max + range * 0.1;
                                        }
                                    },
                                    {
                                        type: 'value',
                                        gridIndex: 2,
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'value',
                                        gridIndex: 3,
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'value',
                                        gridIndex: 4,
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'value',
                                        gridIndex: 5,
                                        min: 0,
                                        max: 100,
                                        splitLine: {
                                            show: false
                                        }
                                    },
                                    {
                                        type: 'value',
                                        gridIndex: 6,
                                        splitLine: {
                                            show: false
                                        },
                                        axisLabel: {
                                            formatter: function(value) {
                                                return value.toFixed(1);
                                            }
                                        },
                                        min: function(value) {
                                            // 计算BOLL线条的最小值
                                            const allValues = [];
                                            if (typeof bollResult !== 'undefined') {
                                                if (bollResult.upper) allValues.push(...bollResult.upper.filter(v => v !== null).map(v => parseFloat(v)));
                                                if (bollResult.ma) allValues.push(...bollResult.ma.filter(v => v !== null).map(v => parseFloat(v)));
                                                if (bollResult.lower) allValues.push(...bollResult.lower.filter(v => v !== null).map(v => parseFloat(v)));
                                            }
                                            
                                            if (allValues.length === 0) return value.min;
                                            
                                            const min = Math.min(...allValues);
                                            const max = Math.max(...allValues);
                                            const range = max - min;
                                            
                                            // 确保有足够的空间，使线条之间的差距更明显
                                            return min - range * 0.1;
                                        },
                                        max: function(value) {
                                            // 计算BOLL线条的最大值
                                            const allValues = [];
                                            if (typeof bollResult !== 'undefined') {
                                                if (bollResult.upper) allValues.push(...bollResult.upper.filter(v => v !== null).map(v => parseFloat(v)));
                                                if (bollResult.ma) allValues.push(...bollResult.ma.filter(v => v !== null).map(v => parseFloat(v)));
                                                if (bollResult.lower) allValues.push(...bollResult.lower.filter(v => v !== null).map(v => parseFloat(v)));
                                            }
                                            
                                            if (allValues.length === 0) return value.max;
                                            
                                            const min = Math.min(...allValues);
                                            const max = Math.max(...allValues);
                                            const range = max - min;
                                            
                                            // 确保有足够的空间，使线条之间的差距更明显
                                            return max + range * 0.1;
                                        }
                                    }
                                ],
                                series: [
                                    {
                                        name: 'K线',
                                        type: 'candlestick',
                                        data: klineData,
                                        itemStyle: {
                                            color: '#ef5350',
                                            color0: '#26a69a',
                                            borderColor: '#ef5350',
                                            borderColor0: '#26a69a'
                                        },
                                        emphasis: {
                                            itemStyle: {
                                                color: '#ff5722',
                                                color0: '#4caf50',
                                                borderColor: '#ff5722',
                                                borderColor0: '#4caf50'
                                            }
                                        }
                                    },
                                    {
                                        name: 'MA5',
                                        type: 'line',
                                        data: ma5,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        lineStyle: {
                                            width: 2,
                                            color: '#FF8C00'
                                        }
                                    },
                                    {
                                        name: 'MA10',
                                        type: 'line',
                                        data: ma10,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        lineStyle: {
                                            width: 2,
                                            color: '#FFD700'
                                        }
                                    },
                                    {
                                        name: 'MA20',
                                        type: 'line',
                                        data: ma20,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        lineStyle: {
                                            width: 2,
                                            color: '#00BFFF'
                                        }
                                    },
                                    {
                                        name: 'MA30',
                                        type: 'line',
                                        data: ma30,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        lineStyle: {
                                            width: 2,
                                            color: '#9370DB'
                                        }
                                    },
                                    {
                                        name: 'MA60',
                                        type: 'line',
                                        data: ma60,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 1,
                                        yAxisIndex: 1,
                                        lineStyle: {
                                            width: 2,
                                            color: '#32CD32'
                                        }
                                    },
                                    {
                                        name: '成交量',
                                        type: 'bar',
                                        xAxisIndex: 3,
                                        yAxisIndex: 3,
                                        data: volumeData,
                                        itemStyle: {
                                            color: function(params) {
                                                const index = params.dataIndex;
                                                if (klineData[index][1] >= klineData[index][0]) {
                                                    return '#ef5350';
                                                } else {
                                                    return '#26a69a';
                                                }
                                            }
                                        }
                                    },
                                    {
                                        name: 'VOL5',
                                        type: 'line',
                                        xAxisIndex: 3,
                                        yAxisIndex: 3,
                                        data: volMA5,
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF8C00'
                                        }
                                    },
                                    {
                                        name: 'VOL10',
                                        type: 'line',
                                        xAxisIndex: 3,
                                        yAxisIndex: 3,
                                        data: volMA10,
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FFD700'
                                        }
                                    },
                                    {
                                        name: 'DIF',
                                        type: 'line',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.dif.map(d => d.toFixed(4)),
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF8C00'
                                        }
                                    },
                                    {
                                        name: 'DEA',
                                        type: 'line',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.dea.map(d => d.toFixed(4)),
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#00BFFF'
                                        }
                                    },
                                    {
                                        name: 'MACD',
                                        type: 'bar',
                                        xAxisIndex: 2,
                                        yAxisIndex: 2,
                                        data: macdResult.macd.map(d => d.toFixed(4)),
                                        itemStyle: {
                                            color: function(params) {
                                                return params.data >= 0 ? '#ef5350' : '#26a69a';
                                            }
                                        }
                                    },
                                    {
                                        name: 'K',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.k,
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#FF8C00'
                                        }
                                    },
                                    {
                                        name: 'D',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.d,
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#00BFFF'
                                        }
                                    },
                                    {
                                        name: 'J',
                                        type: 'line',
                                        xAxisIndex: 4,
                                        yAxisIndex: 4,
                                        data: kdjResult.j,
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#32CD32'
                                        }
                                    },
                                    {
                                        name: 'RSI14',
                                        type: 'line',
                                        xAxisIndex: 5,
                                        yAxisIndex: 5,
                                        data: rsi14,
                                        smooth: true,
                                        showSymbol: false,
                                        lineStyle: {
                                            width: 1,
                                            color: '#9370DB'
                                        },
                                        markLine: {
                                            silent: true,
                                            lineStyle: {
                                                color: '#999'
                                            },
                                            data: [
                                                { yAxis: 70, name: '超买' },
                                                { yAxis: 50, name: '中性' },
                                                { yAxis: 30, name: '超卖' }
                                            ]
                                        }
                                    },
                                    {
                                        name: 'BOLL上轨',
                                        type: 'line',
                                        data: bollResult.upper,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 6,
                                        yAxisIndex: 6,
                                        lineStyle: {
                                            width: 2,
                                            color: '#FF8C00'
                                        }
                                    },
                                    {
                                        name: 'BOLL中轨',
                                        type: 'line',
                                        data: bollResult.ma,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 6,
                                        yAxisIndex: 6,
                                        lineStyle: {
                                            width: 2,
                                            color: '#00BFFF'
                                        }
                                    },
                                    {
                                        name: 'BOLL下轨',
                                        type: 'line',
                                        data: bollResult.lower,
                                        smooth: true,
                                        showSymbol: false,
                                        xAxisIndex: 6,
                                        yAxisIndex: 6,
                                        lineStyle: {
                                            width: 2,
                                            color: '#32CD32'
                                        }
                                    }
                                ]
                            });
                            
                            // 存储当前数据
                            currentStockData = data;
                            
                            // 更新顶部数据
                            if (data.length > 0) {
                                const lastData = data[data.length - 1];
                                // Use name/symbol from API response if available
                                const resolvedSymbol = response.data.symbol || stockCode;
                                const shortCode = resolvedSymbol.includes('.') ? resolvedSymbol.split('.')[1] : resolvedSymbol;
                                const stockName = response.data.name || stockNameMap[shortCode] || stockNameMap[resolvedSymbol] || resolvedSymbol;
                                
                                document.getElementById('stock-name').textContent = `${stockName} (${resolvedSymbol})`;
                                document.getElementById('stock-price').textContent = lastData.close;
                                document.getElementById('stock-high').textContent = lastData.high;
                                document.getElementById('stock-low').textContent = lastData.low;
                                document.getElementById('stock-open').textContent = lastData.open;
                                // Convert volume to "Wan" if large enough
                                const vol = parseInt(lastData.volume);
                                document.getElementById('stock-volume').textContent = vol > 10000 ? (vol / 10000).toFixed(2) + '万' : vol;
                                
                                // Set color based on change
                                const priceEl = document.getElementById('stock-price');
                                const prevClose = data.length > 1 ? parseFloat(data[data.length - 2].close) : parseFloat(lastData.open);
                                const currentClose = parseFloat(lastData.close);
                                
                                if (currentClose > prevClose) {
                                    priceEl.style.color = '#ff3333';
                                } else if (currentClose < prevClose) {
                                    priceEl.style.color = '#26a69a';
                                } else {
                                    priceEl.style.color = '#e0e0e0';
                                }
                            }
                            currentKlineData = klineData;
                            currentVolumeData = volumeData;
                            currentDates = dates;
                            currentChineseDates = chineseDates;
                            currentMAData = { ma5, ma10, ma20, ma30, ma60 };
                            currentVolumeMAData = { volMA5, volMA10 };
                            currentMACDData = macdResult;
                            currentRSIData = rsi14;
                            currentKDJData = kdjResult;
                            currentBOLLData = bollResult;
                            
                        } else {
                            chart.setOption({
                                title: {
                                    text: `股票K线图 - ${stockCode} (数据获取失败)`
                                }
                            });
                            errorMessage.textContent = `数据获取失败: ${response.data.error}`;
                        }
                    })
                    .catch(error => {
                        console.error('获取股票数据失败:', error);
                        isRequesting = false;
                        chart.setOption({
                            title: {
                                text: `股票K线图 - ${stockCode} (网络错误)`
                            }
                        });
                        errorMessage.textContent = `网络错误: ${error.message}`;
                    });
            } catch (error) {
                console.error('获取股票数据失败:', error);
                isRequesting = false;
                errorMessage.textContent = `错误: ${error.message}`;
            }
        }
        
        // 搜索股票
        function searchStocks() {
            const keyword = document.getElementById('stock-symbol').value;
            if (!keyword) {
                return;
            }
            
            // 调用后端API搜索股票
            axios.get(`http://localhost:5001/api/stock/search?keyword=${encodeURIComponent(keyword)}`)
                .then(response => {
                    if (response.data.success) {
                        const results = response.data.data;
                        displaySearchResults(results);
                    }
                })
                .catch(error => {
                    console.error('搜索股票失败:', error);
                });
        }
        
        // 处理搜索输入
        function handleSearchInput(value) {
            if (value.length >= 1) {
                searchStocks();
            } else {
                document.getElementById('search-results').style.display = 'none';
            }
        }
        
        // 显示搜索结果
        function displaySearchResults(results) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            results.forEach(item => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <span class="stock-code">${item.code}</span>
                    <span class="stock-name">${item.name}</span>
                `;
                resultItem.onclick = function() {
                    document.getElementById('stock-symbol').value = item.code;
                    resultsContainer.style.display = 'none';
                    fetchStockData();
                };
                resultsContainer.appendChild(resultItem);
            });
            
            resultsContainer.style.display = 'block';
        }
        
        // 切换AI侧边栏
        function toggleSidebar() {
            const sidebar = document.getElementById('ai-sidebar');
            sidebar.classList.toggle('open');
            
            // 调整图表大小
            setTimeout(() => {
                if (chart) {
                    chart.resize();
                }
            }, 350); // 等待过渡动画完成
        }

        // 分析当前股票
        function analyzeCurrentStock() {
            const symbol = document.getElementById('stock-symbol').value;
            if (!symbol) {
                alert('请先输入股票代码或名称。');
                return;
            }

            // 清空之前的报告并显示加载中
            const reportContainer = document.getElementById('ai-report-container');
            reportContainer.innerHTML = '<div style="color: #888; text-align: center; margin-top: 50px;">正在生成分析报告...</div>';

            // 显示加载状态
            showLoadingIndicator();

            // 转换股票代码逻辑
            let stockCode = symbol;
            
            console.log('开始AI分析，股票代码:', stockCode);

            // 调用后端API获取AI分析数据
            axios.get(`http://localhost:5001/api/stock/ai-analysis/${stockCode}`, {
                timeout: 30000
            })
            .then(response => {
                if (response.data.success) {
                    const data = response.data.data;
                    const formattedData = JSON.stringify(data, null, 2);
                    
                    // 调用后端AI分析API
                    return axios.post('http://localhost:5001/api/ai/analyze', {
                        stock_data: formattedData
                    });
                } else {
                    throw new Error(response.data.error || '获取数据失败');
                }
            })
            .then(response => {
                hideLoadingIndicator();
                if (response && response.data && response.data.success) {
                    const result = response.data.result;
                    // 显示报告 (简单文本渲染)
                    reportContainer.innerHTML = `<div style="padding: 15px; line-height: 1.6;">${result.replace(/\n/g, '<br>')}</div>`;
                    // 滚动到顶部
                    reportContainer.scrollTop = 0;
                } else {
                    throw new Error(response?.data?.error || '分析失败');
                }
            })
            .catch(error => {
                hideLoadingIndicator();
                console.error('AI分析失败:', error);
                reportContainer.innerHTML = `<div style="color: #ff3333; text-align: center; margin-top: 50px;">分析失败: ${error.message}</div>`;
            });
        }

        // 显示加载指示器
        function showLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'flex';
        }
        
        // 隐藏加载指示器
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.style.display = 'none';
        }

        // --- Curve Editor Logic ---
        const curveCanvas = document.getElementById('curveEditor');
        const ctx = curveCanvas.getContext('2d');
        const curveWidth = curveCanvas.width;
        const curveHeight = curveCanvas.height;
        const curvePadding = 40;
        
        // State
        let points = []; 
        let draggingPoint = null;
        let hoverPoint = null;
        
        // Initialize
        function resetEditor() {
            points = [
                { x: curvePadding, y: curveHeight / 2 },
                { x: curveWidth - curvePadding, y: curveHeight / 2 }
            ];
            drawCurve();
        }
        
        // Coordinate conversion
        function getMousePos(evt) {
            const rect = curveCanvas.getBoundingClientRect();
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }
        
        function isNearPoint(p1, p2, threshold = 10) {
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            return Math.sqrt(dx*dx + dy*dy) < threshold;
        }
        
        // Interaction Handlers
        curveCanvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            
            // Check existing points
            for (let i = 0; i < points.length; i++) {
                if (isNearPoint(pos, points[i])) {
                    draggingPoint = i;
                    return;
                }
            }
            
            // Add new point
            points.sort((a, b) => a.x - b.x);
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i+1];
                if (pos.x > p1.x && pos.x < p2.x) {
                    const t = (pos.x - p1.x) / (p2.x - p1.x);
                    const yOnLine = p1.y + t * (p2.y - p1.y);
                    if (Math.abs(pos.y - yOnLine) < 15) {
                        const newPoint = { x: pos.x, y: pos.y };
                        points.splice(i + 1, 0, newPoint);
                        draggingPoint = i + 1;
                        drawCurve();
                        return;
                    }
                }
            }
        });
        
        curveCanvas.addEventListener('mousemove', (e) => {
            const pos = getMousePos(e);
            if (draggingPoint !== null) {
                const p = points[draggingPoint];
                p.y = Math.max(curvePadding, Math.min(curveHeight - curvePadding, pos.y));
                
                // Constrain X
                if (draggingPoint === 0) {
                    p.x = curvePadding; 
                } else if (draggingPoint === points.length - 1) {
                    p.x = curveWidth - curvePadding;
                } else {
                    const prev = points[draggingPoint - 1];
                    const next = points[draggingPoint + 1];
                    p.x = Math.max(prev.x + 5, Math.min(next.x - 5, pos.x));
                }
                drawCurve();
            } else {
                let found = null;
                for (let i = 0; i < points.length; i++) {
                    if (isNearPoint(pos, points[i])) {
                        found = i;
                        break;
                    }
                }
                if (found !== hoverPoint) {
                    hoverPoint = found;
                    curveCanvas.style.cursor = hoverPoint !== null ? 'pointer' : 'crosshair';
                    drawCurve();
                }
            }
        });
        
        curveCanvas.addEventListener('mouseup', () => { draggingPoint = null; });
        curveCanvas.addEventListener('mouseleave', () => { draggingPoint = null; });
        curveCanvas.addEventListener('dblclick', (e) => {
            const pos = getMousePos(e);
            for (let i = 1; i < points.length - 1; i++) {
                if (isNearPoint(pos, points[i])) {
                    points.splice(i, 1);
                    drawCurve();
                    return;
                }
            }
        });

        function drawCurve() {
            ctx.clearRect(0, 0, curveWidth, curveHeight);
            
            // Grid (Dark Mode)
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<=10; i++) {
                ctx.moveTo(0, i * curveHeight/10);
                ctx.lineTo(curveWidth, i * curveHeight/10);
                ctx.moveTo(i * curveWidth/10, 0);
                ctx.lineTo(i * curveWidth/10, curveHeight);
            }
            ctx.stroke();
            
            // Connecting Lines
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 3;
            ctx.beginPath();
            if (points.length > 0) {
                ctx.moveTo(points[0].x, points[0].y);
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
            }
            ctx.stroke();
            
            // Points
            points.forEach((p, i) => {
                ctx.fillStyle = (i === hoverPoint || i === draggingPoint) ? '#e74c3c' : '#2980b9';
                ctx.beginPath();
                ctx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function getCurveData() {
            const result = [];
            const steps = 20;
            const startX = curvePadding;
            const totalWidth = curveWidth - 2 * curvePadding;
            
            for (let i = 0; i < steps; i++) {
                const targetX = startX + (i / (steps - 1)) * totalWidth;
                let y = points[0].y;
                for (let j = 0; j < points.length - 1; j++) {
                    if (targetX >= points[j].x && targetX <= points[j+1].x) {
                        const t = (targetX - points[j].x) / (points[j+1].x - points[j].x);
                        y = points[j].y + t * (points[j+1].y - points[j].y);
                        break;
                    }
                }
                result.push(curveHeight - y);
            }
            return result;
        }

        function initResultChart(chartInstance, data, title, color) {
            chartInstance.setOption({
                backgroundColor: '#1e1e1e',
                title: { text: title, left: 'center', textStyle: { fontSize: 12, color: '#eee' } },
                tooltip: { trigger: 'axis' },
                grid: { top: 30, bottom: 20, left: 40, right: 20 },
                xAxis: { type: 'category', show: false },
                yAxis: { type: 'value', scale: true, splitLine: { lineStyle: { color: '#333' } } },
                series: [{
                    data: data,
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    lineStyle: { color: color, width: 2 }
                }]
            });
        }

        async function runCurveSearch() {
            const curve = getCurveData();
            document.getElementById('latency').innerText = '搜索中...';
            
            try {
                // Assuming backend is on port 5002 for similarity search
                const searchRes = await fetch('http://localhost:5002/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ curve: curve })
                });
                const searchData = await searchRes.json();
                
                document.getElementById('latency').innerText = `延迟: ${searchData.latency.toFixed(2)} ms`;
                
                matchCharts.forEach(c => c.clear());
                
                if (searchData.results && searchData.results.length > 0) {
                    searchData.results.forEach((res, index) => {
                        if (index < 3) {
                            // const title = `${res.code} - ${res.name}\nDist: ${res.distance.toFixed(2)}`;
                            // document.getElementById(`match${index+1}-title`).innerText = title;
                            
                            const titleHtml = `
                                <div>${res.code} - ${res.name}</div>
                                <div style="font-size: 0.8em; color: #888; margin: 5px 0;">距离: ${res.distance.toFixed(2)}</div>
                                <div class="match-actions">
                                    <button class="match-btn" onclick="copyMatch('${res.code}', '${res.name}')">复制</button>
                                    <button class="match-btn" onclick="addToFavorites('${res.code}', '${res.name}')">收藏</button>
                                </div>
                            `;
                            document.getElementById(`match${index+1}-title`).innerHTML = titleHtml;
                            
                            initResultChart(matchCharts[index], res.closes, '', '#2980b9');
                        }
                    });
                } else {
                    alert('No matches found.');
                }
            } catch (e) {
                console.error(e);
                document.getElementById('latency').innerText = 'Error';
                alert('Connection failed. Ensure similarity_web.py is running on port 5002.');
            }
        }
        
        // --- Favorites & Utilities ---

        let favorites = [];

        function loadFavorites() {
            const stored = localStorage.getItem('stock_favorites');
            if (stored) {
                try {
                    favorites = JSON.parse(stored);
                } catch (e) {
                    console.error('Failed to parse favorites', e);
                    favorites = [];
                }
            }
            renderFavorites();
        }

        function saveFavorites() {
            localStorage.setItem('stock_favorites', JSON.stringify(favorites));
            renderFavorites();
        }

        function renderFavorites() {
            const list = document.getElementById('favorites-list');
            if (favorites.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">暂无收藏</div>';
                return;
            }

            list.innerHTML = favorites.map(fav => `
                <div class="favorite-item" onclick="viewStock('${fav.code}')">
                    <div class="favorite-info">
                        <span class="favorite-code">${fav.code}</span>
                        <span class="favorite-name">${fav.name}</span>
                    </div>
                    <div class="favorite-actions">
                        <button onclick="event.stopPropagation(); removeFromFavorites('${fav.code}')" title="删除">×</button>
                    </div>
                </div>
            `).join('');
        }

        function addToFavorites(code, name) {
            if (favorites.some(f => f.code === code)) {
                alert('该股票已在收藏夹中');
                return;
            }
            favorites.push({ code, name, addedAt: new Date().toISOString() });
            saveFavorites();
            
            // Auto open panel to show confirmation
            const panel = document.getElementById('favorites-panel');
            if (panel.style.display !== 'flex') {
                panel.style.display = 'flex';
                // Auto close after 2 seconds if it wasn't open
                setTimeout(() => {
                    // panel.style.display = 'none'; 
                }, 2000);
            }
        }

        function removeFromFavorites(code) {
            favorites = favorites.filter(f => f.code !== code);
            saveFavorites();
        }

        function toggleFavorites() {
            const panel = document.getElementById('favorites-panel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        function copyMatch(code, name) {
            const text = `${code} ${name}`;
            navigator.clipboard.writeText(text).then(() => {
                alert(`已复制: ${text}`);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function viewStock(code) {
            // Switch to stock analysis page
            document.querySelector('[data-page="stock-analysis"]').click();
            // Set input and fetch
            document.getElementById('stock-symbol').value = code;
            fetchStockData();
            // Close favorites on mobile/small screens or generally
            if (window.innerWidth < 800) {
                toggleFavorites();
            }
        }

        function addCurrentToFavorites() {
            const input = document.getElementById('stock-symbol').value;
            // Try to find name from map or current display
            let name = stockNameMap[input] || '未知名称';
            
            // Try to extract from title if possible, e.g. "平安银行 (000001)"
            const nameEl = document.getElementById('stock-name');
            if (nameEl) {
                const text = nameEl.innerText; // "平安银行 (000001)"
                const match = text.match(/^(.*?)\s*\(/);
                if (match) {
                    name = match[1];
                }
            }
            
            if (input) {
                addToFavorites(input, name);
            } else {
                alert('请输入有效股票代码');
            }
        }

        function exportFavorites() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(favorites));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "stock_favorites.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importFavorites(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        // Merge or replace? Let's merge unique codes
                        let count = 0;
                        imported.forEach(item => {
                            if (item.code && !favorites.some(f => f.code === item.code)) {
                                favorites.push(item);
                                count++;
                            }
                        });
                        saveFavorites();
                        alert(`成功导入 ${count} 个新收藏`);
                    } else {
                        alert('文件格式错误');
                    }
                } catch (err) {
                    alert('无法解析文件');
                    console.error(err);
                }
            };
            reader.readAsText(file);
            // Reset input
            input.value = '';
        }

        // Initialize Favorites
        loadFavorites();

        // Initialize Curve Editor
        if (typeof resetEditor === 'function') {
            resetEditor();
        }
    </script>
</body>
</html>